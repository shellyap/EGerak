<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>E-Gerak PPD Ranau — Final (Corrected)</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React & ReactDOM UMD -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Babel (in-browser JSX) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Lucide icons UMD -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <!-- Firebase v9 compat -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    @media print { .no-print{display:none!important} }
    .chart-container { max-width: 420px; margin: 0 auto; }
    .donut-center {
      position: absolute;
      inset: 0;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      pointer-events:none;
    }
    .legend-list { max-height:220px; overflow:auto; }
    .card-heading { border-bottom: 1px solid rgba(15,23,42,0.06); padding-bottom: 0.75rem; margin-bottom: 0.75rem; }
    /* simple autocomplete styles */
    .suggestions { position: absolute; z-index: 40; background:white; border:1px solid #e6e6e6; width:100%; max-height:220px; overflow:auto; border-radius:6px; box-shadow: 0 6px 18px rgba(2,6,23,0.08); }
    .suggestion-item { padding:8px 10px; cursor:pointer; }
    .suggestion-item:hover { background: #f8fafc; }
  </style>

  <!-- Initialize Firebase (compat) - replace with your config if needed -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBU1n6OAmYxY_SjFuhYkop7C7CrFJja6Do",
      authDomain: "egerak-4f922.firebaseapp.com",
      projectId: "egerak-4f922",
      storageBucket: "egerak-4f922.firebasestorage.app",
      messagingSenderId: "567427021114",
      appId: "1:567427021114:web:cf5496d2fc14eb84893803",
      measurementId: "G-V6CGGJ81JG"
    };
    try { firebase.initializeApp(firebaseConfig); console.log('Firebase (compat) initialized.'); } catch(e){ console.error('Firebase init error', e); }
  </script>
</head>
<body class="bg-slate-50 text-slate-900">
  <div id="root"></div>

  <!-- MAIN APP SCRIPT - Segment 1 starts the app, helpers and data -->
  <script type="text/babel">
  const { useState, useEffect, useMemo, useRef, Component } = React;

  // ---------- Icon helper (Option A) ----------
  const createIcon = (iconName) => (props = {}) => {
    if (typeof lucide === 'undefined') return null;
    const def = lucide.icons ? lucide.icons[iconName] : lucide[iconName];
    if (!def) return null;
    const { size = 18, className = '' } = props;
    return React.createElement('svg', { width: size, height: size, viewBox:'0 0 24 24', fill:'none', stroke:'currentColor', strokeWidth:2, strokeLinecap:'round', strokeLinejoin:'round', className },
      def.map(([tag, attrs], i) => React.createElement(tag, { ...attrs, key: i }))
    );
  };
  // single declaration of icons (Option A)
  const MapPin = createIcon('MapPin');
  const CheckCircle = createIcon('CheckCircle');
  const Plus = createIcon('Plus');
  const Trash2 = createIcon('Trash2');
  const FileSpreadsheet = createIcon('FileSpreadsheet');
  const Printer = createIcon('Printer');
  const LogOut = createIcon('LogOut');

  // ---------- Helpers ----------
  function toAllCaps(s){ return (s||'').toUpperCase(); }
  function formatDate(s){
    if(!s) return '-';
    const p = s.split('-');
    if(p.length!==3) return s;
    return `${p[2]}/${p[1]}/${p[0].slice(-2)}`;
  }
  function isoToDDMMYYYY(iso){
    if(!iso) return '';
    const p = iso.split('-');
    if(p.length!==3) return iso;
    return `${p[2]}/${p[1]}/${p[0]}`;
  }
  function downloadCSV(data, filename){
    const headers = ["Tarikh","Nama","Perkara","Lokasi","Catatan"];
    const rows = data.map(r => [formatDate(r.date), r.userName, r.type, r.location, (r.catatan||'').replace(/(\r\n|\n|\r)/gm,' ')]);
    const csv = "data:text/csv;charset=utf-8," + [headers.join(','), ...rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(','))].join('\n');
    const a=document.createElement('a'); a.href=encodeURI(csv); a.download=filename; document.body.appendChild(a); a.click(); a.remove();
  }

  // Coaching detection
  function isCoachingType(type){
    if(!type) return false;
    const t = type.toLowerCase();
    return t.includes('bimbing') || t.includes('coaching') || t.includes('mentor') || t.includes('latih') || t.includes('sokong');
  }

  // ---------- Fixed school lists (from your input) ----------
  const PRIMARY_SCHOOLS = [
"SEKOLAH KEBANGSAAN GUSI",
"SEKOLAH KEBANGSAAN KARAGASAN",
"SEKOLAH KEBANGSAAN KAWIYAN SUGUT",
"SEKOLAH KEBANGSAAN MALINSAU",
"SEKOLAH KEBANGSAAN MANGKAPOH",
"SEKOLAH KEBANGSAAN SRI GABUNGAN",
"SEKOLAH KEBANGSAAN KAINGARAN",
"SEKOLAH KEBANGSAAN NARADAN",
"SEKOLAH KEBANGSAAN PINAWANTAI",
"SEKOLAH KEBANGSAAN TARAWAS",
"SEKOLAH KEBANGSAAN TIBABAR",
"SEKOLAH KEBANGSAAN TIMBUA",
"SEKOLAH KEBANGSAAN TOGOP DARAT",
"SEKOLAH KEBANGSAAN BUNDU TUHAN",
"SEKOLAH KEBANGSAAN KAULUAN",
"SEKOLAH KEBANGSAAN KINASARABAN",
"SEKOLAH KEBANGSAAN KUNDASANG",
"SEKOLAH KEBANGSAAN MESILOU",
"SEKOLAH KEBANGSAAN PAHU HIMBAAN",
"SEKOLAH KEBANGSAAN PINAUSUK",
"SEKOLAH KEBANGSAAN TAGUDON LAMA",
"SEKOLAH KEBANGSAAN TOBOH",
"SEKOLAH RENDAH KEB.DON BOSCO",
"SEKOLAH KEBANGSAAN RATAU",
"SEKOLAH KEBANGSAAN TUDAN",
"SJK (C) PAI WEN",
"SEKOLAH KEBANGSAAN PEKAN",
"SEKOLAH KEBANGSAAN PEKAN 2",
"SEKOLAH KEBANGSAAN ST BENEDICT",
"SEKOLAH KEBANGSAAN BONGKUD",
"SEKOLAH KEBANGSAAN KIROKOT",
"SEKOLAH KEBANGSAAN LANGSAT",
"SEKOLAH KEBANGSAAN LOHAN",
"SEKOLAH KEBANGSAAN NAPONG",
"SEKOLAH KEBANGSAAN NARAWANG",
"SEKOLAH KEBANGSAAN PERANCANGAN",
"SEKOLAH KEBANGSAAN PORING",
"SEKOLAH KEBANGSAAN SAGIBAN",
"SEKOLAH KEBANGSAAN BADUKAN",
"SEKOLAH KEB. KAMPONG LIBANG",
"SEKOLAH KEBANGSAAN KANDAWAYON",
"SEKOLAH KEBANGSAAN KILIMU",
"SEKOLAH KEBANGSAAN KIMONDOU",
"SEKOLAH KEBANGSAAN KINAPULIIDAN",
"SEKOLAH KEBANGSAAN KITUNTUL",
"SEKOLAH KEBANGSAAN LIPASU",
"SEKOLAH KEBANGSAAN MARAKAU",
"SEKOLAH KEB. MOHIMBOYON",
"SEKOLAH KEBANGSAAN WAANG",
"SEKOLAH KEBANGSAAN KANANAPON",
"SEKOLAH KEBANGSAAN MATUPANG",
"SEKOLAH KEBANGSAAN MIRURU",
"SEKOLAH KEBANGSAAN NALAPAK",
"SEKOLAH KEBANGSAAN NUKAKATAN",
"SEKOLAH KEBANGSAAN NUNUK RAGANG",
"SEKOLAH KEBANGSAAN PAGINATAN",
"SEKOLAH KEBANGSAAN PAUS",
"SEKOLAH KEBANGSAAN SAGINDAI",
"SEKOLAH KEBANGSAAN TAMPIOS",
"SEKOLAH KEBANGSAAN TINANOM",
"SEKOLAH KEBANGSAAN GANA GANA",
"SEKOLAH KEB. KEMBURONGOH",
"SEKOLAH KEBANGSAAN KEPANGIAN",
"SEKOLAH KEBANGSAAN KERANAAN",
"SEKOLAH KEBANGSAAN KINIRASAN",
"SEKOLAH KEBANGSAAN LONGUT",
"SEKOLAH KEBANGSAAN MAUKAB",
"SEKOLAH KEBANGSAAN NAMPASAN",
"SEKOLAH KEBANGSAAN RANDAGONG",
"SEKOLAH KEBANGSAAN TIANG",
"SEKOLAH KEBANGSAAN TUNGOU"
  ].map(s=>s.trim()).filter(Boolean);

  const SECONDARY_SCHOOLS = [
"SMK BUNDU TUHAN",
"SMK KEMBURONGOH",
"SMK KUNDASANG",
"SMK LOHAN",
"SMK MAT SALLEH",
"SMK MATUPANG JAYA",
"SMK RANAU",
"SMK TIMBUA",
"SMK ULU SUGUT",
"SMKA MOHAMAD ALI",
"SMA AL-IRSYADIAH"
  ].map(s=>s.trim()).filter(Boolean);

  // ---------- Firestore refs ----------
  const db = firebase.firestore();
  const rootDoc = db.collection('egerak').doc('main');
  const usersCol = () => rootDoc.collection('users');
  const logsCol = () => rootDoc.collection('logs');
  const locationsCol = () => rootDoc.collection('locations');
  const typesCol = () => rootDoc.collection('activityTypes');

  // seed initial data (small)
  const CURRENT_YEAR = new Date().getFullYear();
  const INITIAL_DATA = {
    users: [
      { id:1, username:'shell', password:'shellyap', role:'admin', name: toAllCaps('Shell Yap'), department: toAllCaps('IT / Pengurusan') },
      { id:2, username:'staff', password:'123', role:'staff', name: toAllCaps('En. Razak'), department: toAllCaps('Unit Pembangunan') },
      { id:3, username:'guru', password:'123', role:'staff', name: toAllCaps('Pn. Siti'), department: toAllCaps('Unit Akademik') }
    ],
    logs: [
      { id:101, userId:2, userName: toAllCaps('En. Razak'), type:'Lawatan Bimbingan', location:'SEKOLAH KEBANGSAAN KILIMU', date:`${CURRENT_YEAR}-10-24`, catatan:'Pemantauan projek.' },
      { id:102, userId:2, userName: toAllCaps('En. Razak'), type:'Mesyuarat', location:'PPD RANAU', date:`${CURRENT_YEAR}-10-25`, catatan:'Mesyuarat penyelarasan.' }
    ],
    locations: [
      { name:'PPD RANAU', category:'Lain-lain' },
      { name:'JPN SABAH', category:'Lain-lain' }
    ],
    activityTypes: ['Lawatan Bimbingan','Mesyuarat','Bengkel','Urusan Rasmi','Pemantauan','Lawatan Tapak']
  };

  async function ensureSeeded(){
    try {
      const doc = await rootDoc.get();
      if(!doc.exists) await rootDoc.set({ createdAt: firebase.firestore.FieldValue.serverTimestamp() });

      const seedIfEmpty = async (colRef, items, mapper=i=>i) => {
        const one = await colRef.limit(1).get();
        if(one.empty){
          const batch = db.batch();
          items.forEach(it => { const r = colRef.doc(); batch.set(r, mapper(it)); });
          await batch.commit();
        }
      };

      await seedIfEmpty(usersCol(), INITIAL_DATA.users, u => ({...u}));
      await seedIfEmpty(locationsCol(), INITIAL_DATA.locations, l => ({...l}));
      await seedIfEmpty(typesCol(), INITIAL_DATA.activityTypes.map(t => ({name:t})), t => ({name:t.name||t}));
      await seedIfEmpty(logsCol(), INITIAL_DATA.logs, l => ({...l}));
      console.log('Seed complete (if empty).');
    } catch(e){
      console.error('Seeding error', e);
      throw e;
    }
  }

  // ---------- ErrorBoundary ----------
  class ErrorBoundary extends Component {
    constructor(p){ super(p); this.state={hasError:false,err:null}; }
    static getDerivedStateFromError(err){ return { hasError:true, err }; }
    render(){ if(this.state.hasError) return <div className="p-6 bg-red-50 text-red-700 rounded">{String(this.state.err)}</div>; return this.props.children; }
  }
   <script type="text/babel">
  // ---------- App ----------
  function App(){
    const [user,setUser] = useState(null);
    const [loading,setLoading] = useState(true);
    const [error,setError] = useState('');
    const [notice,setNotice] = useState('');
    const [users,setUsers] = useState([]);
    const [logs,setLogs] = useState([]);
    const [locations,setLocations] = useState([]);
    const [types,setTypes] = useState([]);

    useEffect(()=> {
      let uUn, lUn, locUn, tUn;
      (async ()=>{
        try{
          await ensureSeeded();
          uUn = usersCol().orderBy('id','asc').onSnapshot(snap => setUsers(snap.docs.map(d => ({ docId:d.id, ...d.data() }))));
          locUn = locationsCol().orderBy('name').onSnapshot(snap => setLocations(snap.docs.map(d => ({ docId:d.id, ...d.data() }))));
          tUn = typesCol().orderBy('name').onSnapshot(snap => setTypes(snap.docs.map(d => ({ docId:d.id, ...d.data() }))));
          lUn = logsCol().orderBy('date','desc').onSnapshot(snap => setLogs(snap.docs.map(d => ({ docId:d.id, ...d.data() }))));
          setLoading(false);
        } catch(e){
          console.error(e); setError('Gagal sambung ke pangkalan data.'); setLoading(false);
        }
      })();
      return ()=>{ if(uUn) uUn(); if(lUn) lUn(); if(locUn) locUn(); if(tUn) tUn(); };
    },[]);

    // auth
    const login = (username,password) => {
      setError('');
      const found = users.find(u => (u.username||'').toLowerCase() === (username||'').toLowerCase() && u.password === password);
      if(found) setUser(found);
      else setError('ID Pengguna atau kata laluan tidak sah.');
    };
    const register = async ({ username, password, name, department }) => {
      try {
        if(users.some(u => (u.username||'').toLowerCase() === (username||'').toLowerCase())) return setError('Username sudah wujud.');
        const max = users.reduce((m,u)=>Math.max(m,u.id||0),0);
        const payload = { id: max+1, username, password, role:'staff', name: toAllCaps(name), department: toAllCaps(department||'') };
        await usersCol().add(payload);
        setNotice('Pendaftaran berjaya. Sila log masuk.');
      } catch(e){ console.error(e); setError('Gagal mendaftar.'); }
    };
    const logout = ()=>{ setUser(null); setError(''); setNotice(''); };

    // CRUD wrappers
    const addLog = async (payload) => {
      if(!user) return setError('Sila log masuk.');
      try {
        const id = Date.now();
        await logsCol().add({ id, userId: user.id, userName: user.name, ...payload });
        // ensure Lain-lain locations added if necessary
        if(payload._isNewLainLain){
          await locationsCol().add({ name: payload.location, category: 'Lain-lain' });
        } else {
          const found = (locations||[]).find(l => l.name === payload.location);
          if(!found && payload.location) await locationsCol().add({ name: payload.location, category: 'Lain-lain' });
        }
        setNotice('Rekod berjaya disimpan.'); setTimeout(()=>setNotice(''),2000);
      } catch(e){ console.error(e); setError('Gagal simpan rekod.'); }
    };

    const deleteLog = async (docId) => { try { await logsCol().doc(docId).delete(); } catch(e){ console.error(e); setError('Gagal padam rekod.'); } };

    const addLocation = async (loc) => { try { if(locations.some(l=>l.name===loc.name && l.category===loc.category)) return setError('Lokasi sudah wujud.'); await locationsCol().add(loc); } catch(e){ console.error(e); setError('Gagal tambah lokasi.'); } };
    const deleteLocation = async (docId) => { try { await locationsCol().doc(docId).delete(); } catch(e){ console.error(e); setError('Gagal padam lokasi.'); } };

    const addType = async (name) => { try { if(types.some(t=>t.name===name)) return setError('Perkara sudah wujud.'); await typesCol().add({ name }); } catch(e){ console.error(e); setError('Gagal tambah perkara.'); } };
    const deleteType = async (docId) => { try { await typesCol().doc(docId).delete(); } catch(e){ console.error(e); setError('Gagal padam perkara.'); } };

    const addUser = async (u) => { try { if(users.some(x=> (x.username||'').toLowerCase()===(u.username||'').toLowerCase())) return setError('Username exists'); const max = users.reduce((m,x)=>Math.max(m,x.id||0),0); await usersCol().add({ id: max+1, ...u }); } catch(e){ console.error(e); setError('Gagal tambah pengguna.'); } };
    const deleteUser = async (docId) => { try { await usersCol().doc(docId).delete(); } catch(e){ console.error(e); setError('Gagal padam pengguna.'); } };
    const resetPassword = async (docId) => { try { await usersCol().doc(docId).update({ password: '123' }); } catch(e){ console.error(e); setError('Gagal reset password.'); } };

    // computed lists
    const lainlainLocations = useMemo(()=> (locations||[]).filter(l=> (l.category||'').toLowerCase() === 'lain-lain'), [locations]);
    const combinedLocations = useMemo(()=> {
      const master = lainlainLocations.map(l=>({ name: l.name, category: l.category }));
      const sr = PRIMARY_SCHOOLS.map(n=>({ name: n, category: 'Sekolah Rendah' }));
      const sm = SECONDARY_SCHOOLS.map(n=>({ name: n, category: 'Sekolah Menengah' }));
      return [...sr, ...sm, ...master].sort((a,b)=> (a.name||'').localeCompare(b.name||''));
    }, [lainlainLocations]);

    const combinedTypes = useMemo(()=> {
      const t = (types||[]).map(x=>x.name||x).filter(Boolean);
      const fromLogs = Array.from(new Set((logs||[]).map(l=>l.type).filter(Boolean)));
      return Array.from(new Set([...t, ...fromLogs])).sort();
    }, [types, logs]);

    const allUserNames = useMemo(()=> Array.from(new Set([...(users||[]).map(u=>u.name), ...(logs||[]).map(l=>l.userName)])).sort(), [users, logs]);

    if(loading) return <div className="min-h-screen flex items-center justify-center">Menyambung ke pangkalan data...</div>;
    if(!user) return <Login onLogin={login} onRegister={register} error={error} success={notice} />;

    return (
      <div className="min-h-screen">
        <ErrorBoundary>
          <Header user={user} onLogout={logout} />
          <div className="p-6 md:p-8">
            <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
              <div className="md:col-span-3">
                {user.role === 'staff' ? (
                  <StaffArea user={user} logs={logs.filter(l=>l.userId===user.id || user.role==='admin')} onAddLog={addLog} combinedLocations={combinedLocations} combinedTypes={combinedTypes} lainlainLocations={lainlainLocations} addLocationToMaster={addLocation} />
                ) : (
                  <AdminArea user={user} logs={logs} users={users} locations={locations} types={types}
                    onAddLocation={addLocation} onDeleteLocation={deleteLocation}
                    onAddType={addType} onDeleteType={deleteType}
                    onAddUser={addUser} onDeleteUser={deleteUser} onResetPassword={resetPassword}
                    onDeleteLog={deleteLog}
                    combinedLocations={combinedLocations} combinedTypes={combinedTypes} allUserNames={allUserNames}
                  />
                )}
              </div>
              <aside className="hidden md:block bg-white border border-slate-100 p-4 rounded-lg h-fit">
                <h3 className="font-bold mb-2">Pantau Cepat</h3>
                <div className="text-sm text-slate-600 mb-3">Jumlah rekod: <strong>{logs.length}</strong></div>
                <div className="text-sm text-slate-600 mb-3">Pengguna terdaftar: <strong>{users.length}</strong></div>
                <div className="text-sm text-slate-600">Lokasi Lain-lain: <strong>{lainlainLocations.length}</strong></div>
              </aside>
            </div>

            <div className="mt-6">
              {error && <div className="bg-red-50 text-red-700 p-3 rounded mb-4">{error}</div>}
              {notice && <div className="bg-green-50 text-green-700 p-3 rounded mb-4">{notice}</div>}
            </div>
          </div>
        </ErrorBoundary>
      </div>
    );
  }

  // ---------- Header ----------
  function Header({ user, onLogout }){
    return (
      <div className="p-4 bg-white border-b border-slate-100">
        <div className="max-w-6xl mx-auto flex items-center justify-between">
          <div className="flex items-center gap-4">
            <div className="bg-blue-900 text-white p-2 rounded">{MapPin({size:18})}</div>
            <div>
              <div className="text-lg font-bold">E-Gerak</div>
              <div className="text-xs text-slate-500">PPD Ranau</div>
            </div>
          </div>
          <div className="flex items-center gap-3">
            <div className="text-sm text-slate-600">{user.name} ({user.role})</div>
            <button onClick={onLogout} className="bg-red-600 text-white px-3 py-2 rounded flex items-center gap-2">{LogOut({size:16})}Log Keluar</button>
          </div>
        </div>
      </div>
    );
  }

  // ---------- Login ----------
  function Login({ onLogin, onRegister, error, success }){
    const [isRegister, setIsRegister] = useState(false);
    const [username, setUsername] = useState('');
    const [password, setPassword] = useState('');
    const [fullName, setFullName] = useState('');
    const [department, setDepartment] = useState('');
    const [roleTab, setRoleTab] = useState('staff');

    const submit = (e) => {
      e.preventDefault();
      if(isRegister){
        onRegister({ username, password, name: fullName, department });
        setUsername(''); setPassword(''); setFullName(''); setDepartment('');
        setIsRegister(false);
      } else onLogin(username, password);
    };

    return (
      <div className="min-h-screen flex items-center justify-center p-4">
        <div className="max-w-md w-full bg-white shadow rounded-xl overflow-hidden border border-slate-100">
          <div className="p-6 bg-blue-900 text-white text-center">
            <div className="mx-auto w-12 h-12 bg-white text-blue-900 rounded-full flex items-center justify-center mb-2">{MapPin({size:18})}</div>
            <h2 className="font-bold text-xl">E-Gerak</h2>
            <div className="text-xs opacity-80">PPD Ranau</div>
          </div>
          <div className="p-6">
            {!isRegister && <div className="flex gap-2 bg-slate-100 rounded p-1 mb-4">
              <button onClick={()=>setRoleTab('staff')} className={`flex-1 py-2 ${roleTab==='staff'? 'bg-white text-blue-900 shadow' : 'text-slate-500'}`}>Staf</button>
              <button onClick={()=>setRoleTab('admin')} className={`flex-1 py-2 ${roleTab==='admin'? 'bg-white text-blue-900 shadow' : 'text-slate-500'}`}>Admin</button>
            </div>}
            <form onSubmit={submit} className="space-y-3">
              {isRegister && <>
                <input required placeholder="Nama Penuh" value={fullName} onChange={e=>setFullName(toAllCaps(e.target.value))} className="w-full p-2 border rounded" />
                <input placeholder="Unit / Sekolah" value={department} onChange={e=>setDepartment(toAllCaps(e.target.value))} className="w-full p-2 border rounded" />
              </>}
              <input required placeholder="ID Pengguna" value={username} onChange={e=>setUsername(e.target.value)} className="w-full p-2 border rounded" />
              <input required type="password" placeholder="Kata Laluan" value={password} onChange={e=>setPassword(e.target.value)} className="w-full p-2 border rounded" />
              {error && <div className="text-red-600 text-sm">{error}</div>}
              {success && <div className="text-green-600 text-sm">{success}</div>}
              <button type="submit" className="w-full bg-blue-900 text-white py-2 rounded">{isRegister ? 'Daftar' : 'Log Masuk'}</button>
            </form>
            <div className="mt-4 text-center">
              {!isRegister ? <button onClick={()=>setIsRegister(true)} className="text-sm text-blue-600">Pengguna baru? Daftar</button> : <button onClick={()=>setIsRegister(false)} className="text-sm text-blue-600">Kembali ke Log Masuk</button>}
            </div>
          </div>
        </div>
      </div>
    );
  }

  // ---------- Staff Area ----------
  function StaffArea({ user, logs, onAddLog, combinedLocations, combinedTypes, lainlainLocations, addLocationToMaster }) {
    const [tab, setTab] = useState('entry');
    return (
      <div>
        <div className="mb-6"><h2 className="text-2xl font-bold">Selamat Datang, {user.name}</h2><div className="text-sm text-slate-500">{user.department}</div></div>
        <div className="flex gap-6 mb-6 border-b">
          <button onClick={()=>setTab('entry')} className={tab==='entry' ? 'py-3 px-4 border-b-2 border-blue-900' : 'py-3 px-4 text-slate-500'}>+ Daftar Pergerakan</button>
          <button onClick={()=>setTab('filter')} className={tab==='filter' ? 'py-3 px-4 border-b-2 border-blue-900' : 'py-3 px-4 text-slate-500'}>Saring Rekod</button>
          <button onClick={()=>setTab('report')} className={tab==='report' ? 'py-3 px-4 border-b-2 border-blue-900' : 'py-3 px-4 text-slate-500'}>Laporan Bulanan</button>
        </div>

        {tab==='entry' && <StaffEntry user={user} onSubmit={onAddLog} combinedTypes={combinedTypes} combinedLocations={combinedLocations} lainlainLocations={lainlainLocations} addLocationToMaster={addLocationToMaster} />}
        {tab==='filter' && <div><StaffFilter logs={logs} combinedLocations={combinedLocations} combinedActivityTypes={combinedTypes} /></div>}
        {tab==='report' && <div><StaffReport logs={logs} /></div>}
      </div>
    );
  }

  // ---------- StaffEntry (Kategori + Searchable SR/SM + Lain-lain add) ----------
  function StaffEntry({ user, onSubmit, combinedTypes, combinedLocations, lainlainLocations, addLocationToMaster }) {
    const [dateISO, setDateISO] = useState(new Date().toISOString().slice(0,10));
    const [category, setCategory] = useState('Sekolah Rendah');
    const [searchText, setSearchText] = useState('');
    const [selectedLocation, setSelectedLocation] = useState('');
    const [selectedLain, setSelectedLain] = useState('');
    const [showAddLain, setShowAddLain] = useState(false);
    const [newLain, setNewLain] = useState('');
    const [type, setType] = useState('');
    const [catatan, setCatatan] = useState('');

    const suggestions = useMemo(()=> {
      const q = (searchText||'').toLowerCase();
      if(category === 'Sekolah Rendah') {
        return PRIMARY_SCHOOLS.filter(s => s.toLowerCase().includes(q)).slice(0,10);
      } else if(category === 'Sekolah Menengah') {
        return SECONDARY_SCHOOLS.filter(s => s.toLowerCase().includes(q)).slice(0,10);
      } else {
        return (lainlainLocations || []).map(l=>l.name).filter(n => n.toLowerCase().includes(q)).slice(0,20);
      }
    }, [category, searchText, lainlainLocations]);

 
  </script>
  <script type="text/babel">
    // Continue StaffEntry component
    const submit = (e) => {
      e.preventDefault();
      let finalLocation = '';
      let isNewLain = false;

      if(category === 'Sekolah Rendah' || category === 'Sekolah Menengah'){
        finalLocation = selectedLocation;
      }
      else {
        if(showAddLain && newLain.trim()){
          finalLocation = newLain.trim().toUpperCase();
          isNewLain = true;
        } else {
          finalLocation = selectedLain;
        }
      }

      if(!finalLocation){
        alert("Sila pilih atau tambah lokasi."); 
        return;
      }

      onSubmit({
        date: dateISO,
        type,
        location: finalLocation,
        catatan,
        _isNewLainLain: isNewLain
      });

      // reset form
      setSearchText('');
      setSelectedLocation('');
      setSelectedLain('');
      setShowAddLain(false);
      setNewLain('');
      setType('');
      setCatatan('');
    };

    return (
      <form onSubmit={submit} className="bg-white p-6 rounded shadow max-w-3xl relative">
        {/* HEADER */}
        <div className="flex items-center gap-3 mb-4">
          <div className="bg-blue-100 text-blue-700 p-3 rounded">
            {Plus({ size:18 })}
          </div>
          <div>
            <div className="font-bold text-lg">Daftar Pergerakan Harian</div>
            <div className="text-sm text-slate-500">Sila isi maklumat pergerakan anda.</div>
          </div>
        </div>

        {/* DATE */}
        <label className="font-semibold block mb-1">Tarikh</label>
        <input type="date" required value={dateISO} 
          onChange={e=>setDateISO(e.target.value)}
          className="border p-2 rounded w-full mb-4" />

        {/* KATEGORI */}
        <label className="font-semibold block mb-1">1. Kategori Lokasi</label>
        <select value={category} onChange={e=>{setCategory(e.target.value); setSearchText(''); setSelectedLocation(''); setSelectedLain('');}} 
          className="border p-2 rounded w-full mb-4">
          <option>Sekolah Rendah</option>
          <option>Sekolah Menengah</option>
          <option>Lain-lain Tempat</option>
        </select>

        {/* LOKASI AUTOCOMPLETE */}
        <label className="font-semibold block mb-1">2. Lokasi / Tempat</label>

        {category!=='Lain-lain Tempat' && (
          <div className="relative mb-4">
            <input placeholder="Taip nama sekolah..." value={searchText}
              onChange={e=>{ setSearchText(e.target.value.toUpperCase()); setSelectedLocation(''); }}
              className="border p-2 rounded w-full" />
            {searchText && suggestions.length>0 && (
              <div className="suggestions">
                {suggestions.map((s,i)=>(
                  <div key={i} className="suggestion-item" 
                    onClick={()=>{ setSelectedLocation(s); setSearchText(s); }}>
                    {s}
                  </div>
                ))}
              </div>
            )}
          </div>
        )}

        {/* Lain-lain Tempat interface */}
        {category==='Lain-lain Tempat' && (
          <div className="mb-4">
            {!showAddLain && (
              <div className="mb-2 flex gap-2">
                <select value={selectedLain}
                  onChange={e=>setSelectedLain(e.target.value)}
                  className="border p-2 rounded flex-1">
                  <option value="">-- Pilih Lokasi --</option>
                  {lainlainLocations.map((l,i)=>(
                    <option key={i} value={l.name}>{l.name}</option>
                  ))}
                </select>
                <button type="button"
                  onClick={()=>setShowAddLain(true)}
                  className="bg-blue-700 text-white px-3 rounded">
                  + Tambah
                </button>
              </div>
            )}

            {showAddLain && (
              <div className="mt-2">
                <input placeholder="Nama tempat baru..." value={newLain}
                  onChange={e=>setNewLain(toAllCaps(e.target.value))}
                  className="border p-2 rounded w-full mb-2" />
                <button type="button" 
                  onClick={()=>setShowAddLain(false)}
                  className="text-sm text-slate-500 underline">
                  Batal tambah
                </button>
              </div>
            )}
          </div>
        )}

        {/* PERKARA / AKTIVITI */}
        <label className="font-semibold block mb-1">3. Perkara / Aktiviti</label>
        <select value={type} onChange={e=>setType(e.target.value)}
          required className="border p-2 rounded w-full mb-4">
          <option value="">-- Pilih Perkara --</option>
          {combinedTypes.map((t,i)=>(
            <option key={i} value={t}>{t}</option>
          ))}
        </select>

        {/* CATATAN */}
        <label className="font-semibold block mb-1">4. Catatan (jika ada)</label>
        <textarea value={catatan} onChange={e=>setCatatan(e.target.value)}
          className="border p-2 rounded w-full mb-4"></textarea>

        <button className="bg-blue-900 text-white px-4 py-2 rounded">Simpan Rekod</button>
      </form>
    );
  }

  // ---------- Staff Filter ----------
  function StaffFilter({ logs, combinedLocations, combinedActivityTypes }) {
    const [nameFilter, setNameFilter] = useState('');
    const [locFilter, setLocFilter] = useState('');
    const [typeFilter, setTypeFilter] = useState('');
    const [dateFilter, setDateFilter] = useState('');
    const filtered = logs.filter(l => {
      return (!nameFilter||l.userName===nameFilter)
        && (!locFilter||l.location===locFilter)
        && (!typeFilter||l.type===typeFilter)
        && (!dateFilter||l.date===dateFilter);
    });

    return (
      <div className="bg-white p-6 rounded shadow">
        <h3 className="font-bold text-lg mb-4">Saring Rekod</h3>

        <div className="grid md:grid-cols-4 gap-4 mb-6">
          <div>
            <label className="text-sm block">Nama</label>
            <input value={nameFilter} onChange={e=>setNameFilter(toAllCaps(e.target.value))}
              className="border p-2 rounded w-full" />
          </div>
          <div>
            <label className="text-sm block">Lokasi</label>
            <select value={locFilter} onChange={e=>setLocFilter(e.target.value)}
              className="border p-2 rounded w-full">
              <option value="">-- Semua --</option>
              {combinedLocations.map((l,i)=>(
                <option key={i} value={l.name}>{l.name}</option>
              ))}
            </select>
          </div>
          <div>
            <label className="text-sm block">Perkara</label>
            <select value={typeFilter} onChange={e=>setTypeFilter(e.target.value)}
              className="border p-2 rounded w-full">
              <option value="">-- Semua --</option>
              {combinedActivityTypes.map((t,i)=>(
                <option key={i} value={t}>{t}</option>
              ))}
            </select>
          </div>
          <div>
            <label className="text-sm block">Tarikh</label>
            <input type="date" value={dateFilter} onChange={e=>setDateFilter(e.target.value)}
              className="border p-2 rounded w-full" />
          </div>
        </div>

        <div className="overflow-auto">
          <table className="w-full border text-sm">
            <thead className="bg-slate-100">
              <tr>
                <th className="p-2 border">Tarikh</th>
                <th className="p-2 border">Nama</th>
                <th className="p-2 border">Perkara</th>
                <th className="p-2 border">Lokasi</th>
                <th className="p-2 border">Catatan</th>
              </tr>
            </thead>
            <tbody>
              {filtered.map((l,i)=>(
                <tr key={i}>
                  <td className="p-2 border">{formatDate(l.date)}</td>
                  <td className="p-2 border">{l.userName}</td>
                  <td className="p-2 border">{l.type}</td>
                  <td className="p-2 border">{l.location}</td>
                  <td className="p-2 border">{l.catatan}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>
    );
  }

  // ---------- Staff Report ----------
  function StaffReport({ logs }) {
    return (
      <div className="bg-white p-6 rounded shadow">
        <h3 className="font-bold text-lg mb-4">Laporan Bulanan</h3>
        <p className="text-sm text-slate-600">
          Bahagian ini boleh ditambah ciri eksport PDF / Excel, statistik per-bulan, dsb.
        </p>
      </div>
    );
  }

 
  </script>
   <script type="text/babel">

  // ---------- Admin Area ----------
  function AdminArea({
    user, logs, users, locations, types,
    onAddLocation, onDeleteLocation,
    onAddType, onDeleteType,
    onAddUser, onDeleteUser, onResetPassword,
    onDeleteLog,
    combinedLocations, combinedTypes, allUserNames
  }) {

    const [tab, setTab] = useState('data');

    return (
      <div>
        <h2 className="text-2xl font-bold mb-2">Admin Dashboard</h2>
        <div className="text-sm text-slate-500 mb-6">{user.department}</div>

        <div className="flex gap-6 border-b mb-6">
          <button className={tab==='data'?'py-3 px-4 border-b-2 border-blue-900':'py-3 px-4 text-slate-500'} onClick={()=>setTab('data')}>Data</button>
          <button className={tab==='analisis'?'py-3 px-4 border-b-2 border-blue-900':'py-3 px-4 text-slate-500'} onClick={()=>setTab('analisis')}>Analisis</button>
          <button className={tab==='statistik'?'py-3 px-4 border-b-2 border-blue-900':'py-3 px-4 text-slate-500'} onClick={()=>setTab('statistik')}>Statistik</button>
          <button className={tab==='leaderboard'?'py-3 px-4 border-b-2 border-blue-900':'py-3 px-4 text-slate-500'} onClick={()=>setTab('leaderboard')}>Leaderboard</button>
          <button className={tab==='laporan'?'py-3 px-4 border-b-2 border-blue-900':'py-3 px-4 text-slate-500'} onClick={()=>setTab('laporan')}>Laporan Bulanan</button>
        </div>

        {tab==='data' && <AdminDataTab {...{users,locations,types,onAddLocation,onDeleteLocation,onAddType,onDeleteType,onAddUser,onDeleteUser,onResetPassword}} />}
        {tab==='analisis' && <AdminAnalisisTab logs={logs} />}
        {tab==='statistik' && <AdminStatistikTab logs={logs} combinedLocations={combinedLocations} combinedTypes={combinedTypes} allUserNames={allUserNames} />}
        {tab==='leaderboard' && <AdminLeaderboardTab logs={logs} />}
        {tab==='laporan' && <AdminLaporanTab logs={logs} />}
      </div>
    );
  }

  // ======================================================
  //                 DATA TAB (USERS / TYPES / LOCATIONS)
  // ======================================================

  function AdminDataTab({ users, locations, types, onAddLocation, onDeleteLocation, onAddType, onDeleteType, onAddUser, onDeleteUser, onResetPassword }) {

    const [newUser, setNewUser] = useState({ username:'', password:'', name:'', department:'' });
    const [newLoc, setNewLoc] = useState('');
    const [newType, setNewType] = useState('');

    return (
      <div className="space-y-10">

        {/* USERS */}
        <div className="bg-white p-6 rounded shadow">
          <h3 className="font-bold text-lg mb-4">Senarai Pengguna</h3>
          <div className="grid md:grid-cols-4 gap-2 mb-4">
            <input placeholder="Username" className="border p-2 rounded" value={newUser.username} onChange={e=>setNewUser({...newUser, username:e.target.value})} />
            <input placeholder="Password" className="border p-2 rounded" value={newUser.password} onChange={e=>setNewUser({...newUser, password:e.target.value})} />
            <input placeholder="Nama" className="border p-2 rounded" value={newUser.name} onChange={e=>setNewUser({...newUser, name:toAllCaps(e.target.value)})} />
            <input placeholder="Unit" className="border p-2 rounded" value={newUser.department} onChange={e=>setNewUser({...newUser, department:toAllCaps(e.target.value)})} />
          </div>
          <button onClick={()=>{ if(newUser.username&&newUser.password) onAddUser({...newUser, role:'staff'}); }} className="bg-blue-900 text-white px-4 py-2 rounded">Tambah Pengguna</button>

          <table className="w-full border mt-4 text-sm">
            <thead className="bg-slate-100">
              <tr>
                <th className="border p-2">Nama</th>
                <th className="border p-2">Username</th>
                <th className="border p-2">Unit</th>
                <th className="border p-2">Tindakan</th>
              </tr>
            </thead>
            <tbody>
              {users.map(u=>(
                <tr key={u.docId}>
                  <td className="border p-2">{u.name}</td>
                  <td className="border p-2">{u.username}</td>
                  <td className="border p-2">{u.department}</td>
                  <td className="border p-2">
                    <button className="text-blue-700 mr-3" onClick={()=>onResetPassword(u.docId)}>Reset</button>
                    <button className="text-red-700" onClick={()=>onDeleteUser(u.docId)}>Padam</button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>

        {/* LOCATIONS */}
        <div className="bg-white p-6 rounded shadow">
          <h3 className="font-bold text-lg mb-4">Lokasi Lain-lain</h3>
          <div className="flex gap-2 mb-4">
            <input placeholder="Tambah Lain-lain Tempat..." className="border p-2 rounded flex-1" value={newLoc} onChange={e=>setNewLoc(toAllCaps(e.target.value))} />
            <button className="bg-blue-900 text-white px-4 py-2 rounded" onClick={()=>{ if(newLoc) onAddLocation({name:newLoc,category:'Lain-lain'}); setNewLoc(''); }}>Tambah</button>
          </div>

          <table className="w-full border text-sm">
            <thead className="bg-slate-100">
              <tr>
                <th className="border p-2">Lokasi</th>
                <th className="border p-2">Kategori</th>
                <th className="border p-2">Tindakan</th>
              </tr>
            </thead>
            <tbody>
              {locations.filter(l=>l.category==='Lain-lain').map(l=>(
                <tr key={l.docId}>
                  <td className="border p-2">{l.name}</td>
                  <td className="border p-2">{l.category}</td>
                  <td className="border p-2">
                    <button className="text-red-700" onClick={()=>onDeleteLocation(l.docId)}>Padam</button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>

        {/* TYPES */}
        <div className="bg-white p-6 rounded shadow">
          <h3 className="font-bold text-lg mb-4">Senarai Perkara / Aktiviti</h3>
          <div className="flex gap-2 mb-4">
            <input placeholder="Tambah Perkara..." className="border p-2 rounded flex-1" value={newType} onChange={e=>setNewType(toAllCaps(e.target.value))} />
            <button className="bg-blue-900 text-white px-4 py-2 rounded" onClick={()=>{ if(newType) onAddType(newType); setNewType(''); }}>Tambah</button>
          </div>

          <table className="w-full border text-sm">
            <thead className="bg-slate-100">
              <tr>
                <th className="border p-2">Perkara</th>
                <th className="border p-2">Tindakan</th>
              </tr>
            </thead>
            <tbody>
              {types.map(t=>(
                <tr key={t.docId}>
                  <td className="border p-2">{t.name}</td>
                  <td className="border p-2">
                    <button className="text-red-700" onClick={()=>onDeleteType(t.docId)}>Padam</button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>

      </div>
    );
  }

  // ======================================================
  //                        ANALISIS TAB
  // ======================================================

  function AdminAnalisisTab({ logs }) {

    return (
      <div className="bg-white p-6 rounded shadow">
        <h3 className="font-bold text-lg mb-4">Analisis (Ringkas)</h3>
        <p className="text-slate-600 text-sm">Bahagian ini boleh dikembangkan lagi (trend mingguan, graf garis, dsb).</p>
        <div className="mt-4 text-sm">
          Jumlah rekod: <strong>{logs.length}</strong>
        </div>
      </div>
    );
  }

  // ======================================================
  //                     STATISTIK TAB (PIE CHARTS)
  // ======================================================

  function AdminStatistikTab({ logs, combinedLocations, combinedTypes, allUserNames }) {

    // SLICERS
    const [bulan, setBulan] = useState('');
    const [staf, setStaf] = useState('');
    const [lokasi, setLokasi] = useState('');
    const [jenis, setJenis] = useState('');

    const filtered = logs.filter(l=>{
      return (!bulan || l.date.slice(5,7)===bulan)
        && (!staf || l.userName===staf)
        && (!lokasi || l.location===lokasi)
        && (!jenis || l.type===jenis);
    });

    // COUNT PER TYPE
    const perType = {};
    filtered.forEach(l=>{
      perType[l.type] = (perType[l.type]||0)+1;
    });

    // COUNT PER LOCATION
    const perLoc = {};
    filtered.forEach(l=>{
      perLoc[l.location] = (perLoc[l.location]||0)+1;
    });

    // COUNT PER STAFF
    const perStaff = {};
    filtered.forEach(l=>{
      perStaff[l.userName] = (perStaff[l.userName]||0)+1;
    });

    return (
      <div className="space-y-10">

        {/* SLICERS */}
        <div className="bg-white p-4 rounded shadow">
          <h3 className="font-bold text-lg mb-4">Slicer Statistik</h3>
          <div className="grid md:grid-cols-4 gap-4 text-sm">

            {/* BULAN */}
            <div>
              <label className="block mb-1 font-semibold">Bulan</label>
              <select className="border p-2 rounded w-full" value={bulan} onChange={e=>setBulan(e.target.value)}>
                <option value="">Semua</option>
                {["01","02","03","04","05","06","07","08","09","10","11","12"].map(b=>(
                  <option key={b} value={b}>{b}</option>
                ))}
              </select>
            </div>

            {/* STAF */}
            <div>
              <label className="block mb-1 font-semibold">Staf</label>
              <select className="border p-2 rounded w-full" value={staf} onChange={e=>setStaf(e.target.value)}>
                <option value="">Semua</option>
                {allUserNames.map((n,i)=>(
                  <option key={i} value={n}>{n}</option>
                ))}
              </select>
            </div>

            {/* LOKASI */}
            <div>
              <label className="block mb-1 font-semibold">Lokasi</label>
              <select className="border p-2 rounded w-full" value={lokasi} onChange={e=>setLokasi(e.target.value)}>
                <option value="">Semua</option>
                {combinedLocations.map((l,i)=>(
                  <option key={i} value={l.name}>{l.name}</option>
                ))}
              </select>
            </div>

            {/* PERKARA */}
            <div>
              <label className="block mb-1 font-semibold">Perkara</label>
              <select className="border p-2 rounded w-full" value={jenis} onChange={e=>setJenis(e.target.value)}>
                <option value="">Semua</option>
                {combinedTypes.map((t,i)=>(
                  <option key={i} value={t}>{t}</option>
                ))}
              </select>
            </div>

          </div>
        </div>

        {/* CHARTS */}
        <div className="grid md:grid-cols-3 gap-6">

          <PieCard title="Peratus Mengikut Perkara" dataObj={perType} />
          <PieCard title="Peratus Mengikut Lokasi" dataObj={perLoc} />
          <PieCard title="Peratus Mengikut Staf" dataObj={perStaff} />

        </div>

      </div>
    );
  }

  // ---------- PIE CARD COMPONENT ----------
  function PieCard({ title, dataObj }) {

    const canvasRef = useRef(null);
    const chartRef = useRef(null);

    const labels = Object.keys(dataObj);
    const values = Object.values(dataObj);
    const total = values.reduce((a,b)=>a+b,0);

    useEffect(()=>{
      if(!canvasRef.current) return;

      if(chartRef.current){
        chartRef.current.destroy();
      }

      chartRef.current = new Chart(canvasRef.current, {
        type: 'doughnut',
        data: {
          labels,
          datasets: [{
            data: values,
            backgroundColor: [
              "#1e3a8a","#0ea5e9","#10b981","#f59e0b","#ef4444",
              "#6366f1","#14b8a6","#84cc16","#d946ef","#a855f7"
            ]
          }]
        },
        options: {
          cutout: '65%',
          plugins: { legend: { display:false } }
        }
      });

    }, [labels.join(','), values.join(',')]);

    return (
      <div className="bg-white p-6 rounded shadow relative chart-container">
        <h3 className="font-bold text-lg mb-4">{title}</h3>

        <div className="relative flex items-center justify-center">
          <canvas ref={canvasRef} className="w-64 h-64"></canvas>

          {/* CENTER TEXT */}
          <div className="donut-center text-center">
            <div className="font-bold text-xl">{total}</div>
            <div className="text-xs text-slate-500">Rekod</div>
          </div>
        </div>

        {/* LEGEND */}
        <div className="legend-list mt-4 space-y-1 text-sm">
          {labels.map((lab,i)=>(
            <div key={i} className="flex items-center gap-2">
              <div className="w-3 h-3 rounded" style={{ backgroundColor: chartRef.current?.data.datasets[0].backgroundColor[i] }}></div>
              <span>{lab} — <strong>{dataObj[lab]}</strong></span>
            </div>
          ))}
        </div>

      </div>
    );
  }

  // ======================================================
  //                  LEADERBOARD TAB (2 SECTIONS)
  // ======================================================

  function AdminLeaderboardTab({ logs }) {

    // TOTAL LOG COUNT PER STAFF
    const totals = {};
    logs.forEach(l=>{
      totals[l.userName] = (totals[l.userName]||0)+1;
    });

    const sortedTotals = Object.entries(totals)
      .sort((a,b)=>b[1]-a[1])
      .map(([name,count])=>({name,count}));

    // COACHING & MENTORING
    const coach = {};
    logs.filter(l=>isCoachingType(l.type)).forEach(l=>{
      coach[l.userName] = (coach[l.userName]||0)+1;
    });

    const sortedCoach = Object.entries(coach)
      .sort((a,b)=>b[1]-a[1])
      .map(([name,count])=>({name,count}));

    return (
      <div className="space-y-10">

        {/* RANKING PENGISIAN */}
        <div className="bg-white p-6 rounded shadow">
          <h3 className="font-bold text-lg mb-4">Ranking Mengikut Pengisian</h3>

          <table className="w-full border text-sm">
            <thead className="bg-slate-100">
              <tr>
                <th className="p-2 border">#</th>
                <th className="p-2 border">Nama</th>
                <th className="p-2 border">Jumlah</th>
              </tr>
            </thead>
            <tbody>
              {sortedTotals.map((u,i)=>(
                <tr key={i}>
                  <td className="border p-2">{i+1}</td>
                  <td className="border p-2">{u.name}</td>
                  <td className="border p-2">{u.count}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>

        {/* COACHING & MENTORING */}
        <div className="bg-white p-6 rounded shadow">
          <h3 className="font-bold text-lg mb-4">Ranking Coaching & Mentoring</h3>

          {sortedCoach.length===0 && (
            <div className="text-sm text-slate-500">Tiada data Coaching / Mentoring direkodkan.</div>
          )}

          {sortedCoach.length>0 && (
            <table className="w-full border text-sm">
              <thead className="bg-slate-100">
                <tr>
                  <th className="p-2 border">#</th>
                  <th className="p-2 border">Nama</th>
                  <th className="p-2 border">Jumlah</th>
                </tr>
              </thead>
              <tbody>
                {sortedCoach.map((u,i)=>(
                  <tr key={i}>
                    <td className="border p-2">{i+1}</td>
                    <td className="border p-2">{u.name}</td>
                    <td className="border p-2">{u.count}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          )}
        </div>

      </div>
    );
  }

  // ======================================================
  //          LAPORAN BULANAN TAB (ADMIN)
  // ======================================================

  function AdminLaporanTab({ logs }) {
    return (
      <div className="bg-white p-6 rounded shadow">
        <h3 className="font-bold text-lg mb-4">Laporan Bulanan</h3>
        <p className="text-sm text-slate-500">Bahagian ini boleh tambah fungsi eksport PDF, Excel, dsb.</p>
      </div>
    );
  }

  
  </script>
    <script type="text/babel">

  // ======================================================
  //                 GLOBAL HELPER FUNCTIONS
  // ======================================================

  // Always convert NAME and UNIT to UPPERCASE
  function toAllCaps(str) {
    return (str || "").toUpperCase();
  }

  // Identify Coaching & Mentoring items (customize later)
  const COACHING_KEYWORDS = ["COACHING", "MENTORING", "BIMBINGAN", "SPSK"];

  function isCoachingType(typeName) {
    if (!typeName) return false;
    const T = typeName.toUpperCase();
    return COACHING_KEYWORDS.some(k => T.includes(k));
  }

  // Preload Google Fonts
  function injectGoogleFonts() {
    const link = document.createElement("link");
    link.rel = "stylesheet";
    link.href = "https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap";
    document.head.appendChild(link);
  }
  injectGoogleFonts();


  // ======================================================
  //                 ROOT REACT APP COMPONENT
  // ======================================================

  function AppRoot() {

    const [currentUser, setCurrentUser] = React.useState(null);
    const [logs, setLogs] = React.useState([]);
    const [users, setUsers] = React.useState([]);
    const [locations, setLocations] = React.useState([]);
    const [types, setTypes] = React.useState([]);
    const [loading, setLoading] = React.useState(true);

    // LOAD FIREBASE DATA IN REALTIME
    React.useEffect(() => {
      const unsub1 = db.collection("Users").onSnapshot(snap => {
        const arr = [];
        snap.forEach(d => arr.push({ docId: d.id, ...d.data() }));
        setUsers(arr);
      });

      const unsub2 = db.collection("Logs").orderBy("createdAt", "desc").onSnapshot(snap => {
        const arr = [];
        snap.forEach(d => arr.push({ docId: d.id, ...d.data() }));
        setLogs(arr);
      });

      const unsub3 = db.collection("Locations").onSnapshot(snap => {
        const arr = [];
        snap.forEach(d => arr.push({ docId: d.id, ...d.data() }));
        setLocations(arr);
      });

      const unsub4 = db.collection("Types").onSnapshot(snap => {
        const arr = [];
        snap.forEach(d => arr.push({ docId: d.id, ...d.data() }));
        setTypes(arr);
      });

      setLoading(false);
      return () => { unsub1(); unsub2(); unsub3(); unsub4(); };
    }, []);

    // MERGE FIXED SCHOOL LIST + USER ADDED LOCATIONS
    const combinedLocations = [
      ...FIXED_SR.map(name => ({ name, category:"Sekolah Rendah" })),
      ...FIXED_SM.map(name => ({ name, category:"Sekolah Menengah" })),
      ...locations.filter(l => l.category === "Lain-lain")
    ];

    // MERGE TYPES FROM DB
    const combinedTypes = types.map(t => t.name);

    // USER NAMES LIST (FOR SLICER)
    const allUserNames = Array.from(new Set(users.map(u => u.name)));

    // SHOW LOGIN IF NOT LOGGED IN
    if (!currentUser) {
      return (
        <LoginPage
          onLogin={u => setCurrentUser(u)}
          users={users}
        />
      );
    }

    // ADMIN
    if (currentUser.role === "admin") {
      return (
        <AdminArea
          user={currentUser}
          logs={logs}
          users={users}
          locations={locations}
          types={types}

          onAddLocation={data => db.collection("Locations").add(data)}
          onDeleteLocation={id => db.collection("Locations").doc(id).delete()}

          onAddType={name => db.collection("Types").add({ name })}
          onDeleteType={id => db.collection("Types").doc(id).delete()}

          onAddUser={data => db.collection("Users").add(data)}
          onDeleteUser={id => db.collection("Users").doc(id).delete()}
          onResetPassword={id => db.collection("Users").doc(id).update({ password:"12345" })}

          onDeleteLog={id => db.collection("Logs").doc(id).delete()}

          combinedLocations={combinedLocations}
          combinedTypes={combinedTypes}
          allUserNames={allUserNames}
        />
      );
    }

    // STAFF VIEW
    return (
      <StaffArea
        user={currentUser}
        logs={logs.filter(l => l.userId === currentUser.docId)}
        combinedLocations={combinedLocations}
        combinedTypes={combinedTypes}
        onLogout={() => setCurrentUser(null)}
      />
    );
  }

  // ======================================================
  //                 MOUNT REACT APP
  // ======================================================

  const root = ReactDOM.createRoot(document.getElementById("root"));
  root.render(<AppRoot />);

  </script>
    <script type="text/babel">

  // ======================================================
  //        FIXED SEKOLAH RENDAH (72 ITEMS) — AUTO SUGGEST
  // ======================================================

  const FIXED_SR = [
    "SEKOLAH KEBANGSAAN GUSI",
    "SEKOLAH KEBANGSAAN KARAGASAN",
    "SEKOLAH KEBANGSAAN KAWIYAN SUGUT",
    "SEKOLAH KEBANGSAAN MALINSAU",
    "SEKOLAH KEBANGSAAN MANGKAPOH",
    "SEKOLAH KEBANGSAAN SRI GABUNGAN",
    "SEKOLAH KEBANGSAAN KAINGARAN",

    "SEKOLAH KEBANGSAAN NARADAN",
    "SEKOLAH KEBANGSAAN PINAWANTAI",
    "SEKOLAH KEBANGSAAN TARAWAS",
    "SEKOLAH KEBANGSAAN TIBABAR",
    "SEKOLAH KEBANGSAAN TIMBUA",
    "SEKOLAH KEBANGSAAN TOGOP DARAT",

    "SEKOLAH KEBANGSAAN BUNDU TUHAN",
    "SEKOLAH KEBANGSAAN KAULUAN",
    "SEKOLAH KEBANGSAAN KINASARABAN",
    "SEKOLAH KEBANGSAAN KUNDASANG",
    "SEKOLAH KEBANGSAAN MESILOU",
    "SEKOLAH KEBANGSAAN PAHU HIMBAAN",
    "SEKOLAH KEBANGSAAN PINAUSUK",
    "SEKOLAH KEBANGSAAN TAGUDON LAMA",
    "SEKOLAH KEBANGSAAN TOBOH",
    "SEKOLAH RENDAH KEB. DON BOSCO",
    "SEKOLAH KEBANGSAAN RATAU",
    "SEKOLAH KEBANGSAAN TUDAN",

    "SJK (C) PAI WEN",
    "SEKOLAH KEBANGSAAN PEKAN",
    "SEKOLAH KEBANGSAAN PEKAN 2",
    "SEKOLAH KEBANGSAAN ST BENEDICT",

    "SEKOLAH KEBANGSAAN BONGKUD",
    "SEKOLAH KEBANGSAAN KIROKOT",
    "SEKOLAH KEBANGSAAN LANGSAT",
    "SEKOLAH KEBANGSAAN LOHAN",
    "SEKOLAH KEBANGSAAN NAPONG",
    "SEKOLAH KEBANGSAAN NARAWANG",
    "SEKOLAH KEBANGSAAN PERANCANGAN",
    "SEKOLAH KEBANGSAAN PORING",
    "SEKOLAH KEBANGSAAN SAGIBAN",

    "SEKOLAH KEBANGSAAN BADUKAN",
    "SEKOLAH KEB. KAMPONG LIBANG",
    "SEKOLAH KEBANGSAAN KANDAWAYON",
    "SEKOLAH KEBANGSAAN KILIMU",
    "SEKOLAH KEBANGSAAN KIMONDOU",
    "SEKOLAH KEBANGSAAN KINAPULIIDAN",
    "SEKOLAH KEBANGSAAN KITUNTUL",
    "SEKOLAH KEBANGSAAN LIPASU",
    "SEKOLAH KEBANGSAAN MARAKAU",
    "SEKOLAH KEB. MOHIMBOYON",
    "SEKOLAH KEBANGSAAN WAANG",

    "SEKOLAH KEBANGSAAN KANANAPON",
    "SEKOLAH KEBANGSAAN MATUPANG",
    "SEKOLAH KEBANGSAAN MIRURU",
    "SEKOLAH KEBANGSAAN NALAPAK",
    "SEKOLAH KEBANGSAAN NUKAKATAN",
    "SEKOLAH KEBANGSAAN NUNUK RAGANG",
    "SEKOLAH KEBANGSAAN PAGINATAN",
    "SEKOLAH KEBANGSAAN PAUS",
    "SEKOLAH KEBANGSAAN SAGINDAI",
    "SEKOLAH KEBANGSAAN TAMPIOS",
    "SEKOLAH KEBANGSAAN TINANOM",

    "SEKOLAH KEBANGSAAN GANA GANA",
    "SEKOLAH KEB. KEMBURONGOH",
    "SEKOLAH KEBANGSAAN KEPANGIAN",
    "SEKOLAH KEBANGSAAN KERANAAN",
    "SEKOLAH KEBANGSAAN KINIRASAN",
    "SEKOLAH KEBANGSAAN LONGUT",
    "SEKOLAH KEBANGSAAN MAUKAB",
    "SEKOLAH KEBANGSAAN NAMPASAN",
    "SEKOLAH KEBANGSAAN RANDAGONG",
    "SEKOLAH KEBANGSAAN ANTIANG",
    "SEKOLAH KEBANGSAAN TUNGOU"
  ];


  // ======================================================
  //           FIXED SEKOLAH MENENGAH (11 ITEMS)
  // ======================================================

  const FIXED_SM = [
    "SMA AL-IRSYADIAH",
    "SMK BUNDU TUHAN",
    "SMK KEMBURONGOH",
    "SMK KUNDASANG",
    "SMK LOHAN",
    "SMK MAT SALLEH",
    "SMK MATUPANG JAYA",
    "SMK RANAU",
    "SMK TIMBUA",
    "SMK ULU SUGUT",
    "SMKA MOHAMAD ALI"
  ];

  </script>

</body>
</html>




