<!-- index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Realtime Sync App</title>
</head>
<body>
  <h1>Realtime Sync App</h1>
  <textarea id="editor" style="width:100%;height:200px;"></textarea>

  <script type="module">
    import { initRealtime, startRealtimeSync } from "./realtime-sync.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBU1n6OAmYxY_SjFuhYkop7C7CrFJja6Do",
      authDomain: "egerak-4f922.firebaseapp.com",
      projectId: "egerak-4f922",
      storageBucket: "egerak-4f922.firebasestorage.app",
      messagingSenderId: "567427021114",
      appId: "1:567427021114:web:cf5496d2fc14eb84893803",
      measurementId: "G-V6CGGJ81JG"
    };

    await initRealtime(firebaseConfig);

    const editor = document.getElementById("editor");

    const sync = startRealtimeSync({
      docPath: "documents/demo",
      getLocal: () => ({ text: editor.value }),
      applyRemote: (remote) => {
        if (remote.text !== editor.value) {
          editor.value = remote.text;
        }
      }
    });

    editor.addEventListener("input", () => {
      sync.pushLocalChange({ text: editor.value }, { author: "user" });
    });
  </script>
</body>
</html>


<!-- realtime-sync.js -->
<script type="text/plain" id="realtime-sync-js">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, onSnapshot, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

let db;

export async function initRealtime(config) {
  const app = initializeApp(config);
  db = getFirestore(app);
  try {
    await enableIndexedDbPersistence(db);
  } catch (e) {
    console.warn("Offline persistence unavailable", e);
  }
}

export function startRealtimeSync({ docPath, getLocal, applyRemote }) {
  const ref = doc(db, docPath);

  onSnapshot(ref, (snapshot) => {
    if (snapshot.exists()) {
      applyRemote(snapshot.data());
    }
  });

  return {
    async pushLocalChange(payload, meta = {}) {
      await setDoc(ref, {
        ...payload,
        _meta: {
          updated: Date.now(),
          ...meta
        }
      });
    }
  };
}
</script>
