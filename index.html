import React, { useState, useEffect, useMemo, useCallback } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
import { 
  getFirestore, collection, query, orderBy, onSnapshot, 
  addDoc, doc, deleteDoc, getDocs, where 
} from 'firebase/firestore';
import { 
  Loader2, MapPin, List, FileText, BarChart2, PieChart, 
  Users, Calendar, LogOut, TrendingUp, Award, Search, 
  Plus, X, Trash2, Clock 
} from 'lucide-react';

// ==========================================
// 1. CONFIGURATION
// ==========================================

const firebaseConfig = {
  // TODO: Replace with your actual keys from Firebase Console
  apiKey: "AIzaSyCpKyfvY-7Gg8QDiAGQdZDJL1ZFmwAH4Hc",
  authDomain: "egerakspbranau.firebaseapp.com",
  projectId: "egerakspbranau",
  storageBucket: "egerakspbranau.firebasestorage.app",
  messagingSenderId: "79955939618",
  appId: "1:79955939618:web:68013f1ad89f9ff4e8957b",
  measurementId: "G-1N0WRLLHVH"
};

const appId = typeof __app_id !== 'undefined' ? __app_id : 'ppd-ranau-tracker-v1';
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// Initialize Firebase
let app, db, auth;
try {
  if (typeof __firebase_config !== 'undefined') {
    app = initializeApp(JSON.parse(__firebase_config));
    db = getFirestore(app);
    auth = getAuth(app);
  } else if (firebaseConfig.apiKey && !firebaseConfig.apiKey.includes("PASTE_YOUR")) {
    app = initializeApp(firebaseConfig);
    db = getFirestore(app);
    auth = getAuth(app);
  } else {
    console.warn("âš ï¸ Firebase config missing! Please update the keys in App.jsx");
  }
} catch (e) {
  console.error("Firebase Init Error:", e);
}

// ==========================================
// 2. HELPERS & CONSTANTS
// ==========================================

const COLLECTIONS = {
  STAFF: `artifacts/${appId}/public/data/staff_list`,
  PLACES: `artifacts/${appId}/public/data/place_list`,
  ACTIVITIES: `artifacts/${appId}/public/data/activity_types`,
  LOGS: `artifacts/${appId}/public/data/movement_logs`,
  USERS: `artifacts/${appId}/public/data/user_credentials`
};

const MONTH_NAMES_SHORT = ['Jan', 'Feb', 'Mac', 'Apr', 'Mei', 'Jun', 'Jul', 'Ogo', 'Sep', 'Okt', 'Nov', 'Dis'];

function formatDate(date) {
  if (!date) return '';
  return new Date(date).toLocaleDateString('sv-SE');
}

function getDaysInMonth(year, month) {
  const date = new Date(year, month - 1, 1);
  const days = [];
  while (date.getMonth() === month - 1) {
    if (date.getDay() !== 0 && date.getDay() !== 6) days.push(new Date(date));
    date.setDate(date.getDate() + 1);
  }
  return days;
}

function convertToCSV(data) {
  const headers = ['Tarikh', 'Masa', 'Nama Staf', 'Tempat Pergerakan', 'Jenis Tempat', 'Perkara/Fokus', 'Catatan/Nota', 'UID Audit'];
  const rows = data.map(log => [
    formatDate(log.timestamp),
    new Date(log.timestamp).toLocaleTimeString('ms-MY', { hour: '2-digit', minute: '2-digit' }),
    `"${(log.staffName || '').replace(/"/g, '""')}"`, 
    `"${(log.placeName || '').replace(/"/g, '""')}"`,
    log.placeType,
    `"${(log.activityType || '').replace(/"/g, '""')}"`,
    `"${(log.notes || '').replace(/"/g, '""')}"`,
    log.userId,
  ].join(','));
  return [headers.join(','), ...rows].join('\n');
}

function downloadCSV(data, filename) {
  const csv = convertToCSV(data);
  const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement("a");
  const url = URL.createObjectURL(blob);
  link.setAttribute("href", url);
  link.setAttribute("download", filename);
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// ==========================================
// 3. HOOKS (Function Declarations for Safety)
// ==========================================

function useAuth() {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (!auth) { setLoading(false); return; }
    const init = async () => {
      try {
        if (initialAuthToken) {
          await signInWithCustomToken(auth, initialAuthToken);
        } else {
          await signInAnonymously(auth);
        }
      } catch (e) { console.error("Auth Error:", e); }
    };
    init();
    return onAuthStateChanged(auth, (u) => { setUser(u); setLoading(false); });
  }, []);
  return { user, userId: user?.uid, loading };
}

function useUserCredentials(userId) {
  const [role, setRole] = useState(null);
  const [profile, setProfile] = useState(null);
  const [authStatus, setAuthStatus] = useState(false);
  const [checking, setChecking] = useState(true);

  const simpleHash = (t) => btoa(t).substring(0, 30); 

  const check = useCallback(async () => {
    if (!db || !userId) { setAuthStatus(false); setChecking(false); return; }
    try {
      const q = query(collection(db, COLLECTIONS.USERS), where("uid", "==", userId));
      const snap = await getDocs(q);
      if (!snap.empty) {
        const d = snap.docs[0].data();
        setProfile(d); setRole(d.role); setAuthStatus(true);
      }
    } catch (e) { console.error(e); }
    finally { setChecking(false); }
  }, [userId]);

  useEffect(() => { check(); }, [check]);

  const register = async (user, pass, name, design) => {
    const cleanUser = user.trim().toLowerCase();
    const cleanName = name.trim().toUpperCase();
    const cleanDesign = design.trim().toUpperCase();

    if (cleanUser === 'shell') throw new Error("Nama pengguna ini dikhaskan.");
    
    const qCheck = query(collection(db, COLLECTIONS.USERS), where("username", "==", cleanUser));
    const snap = await getDocs(qCheck);
    if (!snap.empty) throw new Error("ID Pengguna telah wujud.");
    
    const qNameCheck = query(collection(db, COLLECTIONS.USERS), where("fullName", "==", cleanName));
    const snapName = await getDocs(qNameCheck);
    if (!snapName.empty) throw new Error(`Nama "${cleanName}" sudah didaftarkan.`);

    await addDoc(collection(db, COLLECTIONS.USERS), {
      uid: userId, username: cleanUser, hashedPassword: simpleHash(pass),
      role: 'staff', fullName: cleanName, designation: cleanDesign, createdAt: new Date()
    });

    const qStaff = query(collection(db, COLLECTIONS.STAFF), where("name", "==", cleanName));
    const snapStaff = await getDocs(qStaff);
    if (snapStaff.empty) {
      await addDoc(collection(db, COLLECTIONS.STAFF), { name: cleanName, designation: cleanDesign });
    }
    setProfile({ username: cleanUser, role: 'staff', fullName: cleanName, designation: cleanDesign });
    setRole('staff'); setAuthStatus(true);
  };

  const login = async (user, pass) => {
    const cleanUser = user.trim().toLowerCase();
    if (cleanUser === 'shell' && pass === 'shellyap') {
      const adminData = { username: 'shell', role: 'admin', fullName: 'ADMINISTRATOR', designation: 'SUPER ADMIN' };
      setProfile(adminData); setRole('admin'); setAuthStatus(true); return;
    }
    const q = query(collection(db, COLLECTIONS.USERS), where("username", "==", cleanUser));
    const snap = await getDocs(q);
    if (snap.empty) throw new Error("Pengguna tidak ditemui.");
    const d = snap.docs[0].data();
    if (d.hashedPassword !== simpleHash(pass)) throw new Error("Kata laluan salah.");
    setProfile(d); setRole(d.role); setAuthStatus(true);
  };

  const logout = () => { setAuthStatus(false); setRole(null); setProfile(null); };

  return { role, isAuthenticated: authStatus, profile, checking, register, login, logout };
}

function useDataCollection(path, user, sortField = 'name') {
  const [data, setData] = useState([]);
  useEffect(() => {
    if (!db || !user) return; 
    const q = query(collection(db, path), orderBy(sortField));
    return onSnapshot(q, (s) => setData(s.docs.map(d => ({ id: d.id, ...d.data() }))));
  }, [path, sortField, user]);
  return data;
}

function useLogs(user) {
  const [logs, setLogs] = useState([]);
  const [loading, setLoading] = useState(true);
  useEffect(() => {
    if (!db || !user) { setLoading(false); return; }
    const q = query(collection(db, COLLECTIONS.LOGS), orderBy("timestamp", "desc"));
    return onSnapshot(q, (s) => {
      setLogs(s.docs.map(d => ({
        id: d.id, ...d.data(),
        timestamp: d.data().timestamp?.toDate ? d.data().timestamp.toDate() : new Date(d.data().timestamp || 0)
      })));
      setLoading(false);
    }, (error) => {
      console.error("Log fetch error:", error);
      setLoading(false);
    });
  }, [user]);
  return { logs, loading };
}

// ==========================================
// 4. COMPONENTS
// ==========================================

const ButtonSpinner = ({ text }) => (
  <span className="flex items-center justify-center gap-2">
    <Loader2 className="w-4 h-4 animate-spin" />
    {text}
  </span>
);

const LoadingScreen = () => (
  <div className="min-h-screen flex items-center justify-center bg-gray-50">
    <div className="p-8 bg-white rounded-2xl shadow-xl flex flex-col items-center space-y-4">
      <Loader2 className="w-10 h-10 text-indigo-600 animate-spin" />
      <p className="text-indigo-800 font-semibold text-lg">Memuatkan Sistem...</p>
    </div>
  </div>
);

const LoadingMessage = ({ message }) => (
  <div className="flex items-center justify-center p-6 bg-white rounded-xl shadow-sm border border-gray-100">
    <Loader2 className="w-6 h-6 text-indigo-600 animate-spin mr-3" />
    <p className="text-indigo-700 font-medium">{message}</p>
  </div>
);

const SimplePieChart = ({ data, title }) => {
  const total = data.reduce((acc, cur) => acc + cur.value, 0);
  let cumulativePercent = 0;

  if (total === 0) return (
    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 h-full flex flex-col items-center justify-center">
      <h4 className="font-bold text-gray-700 mb-2 text-sm">{title}</h4>
      <div className="text-sm text-gray-400 bg-gray-50 px-4 py-2 rounded-full">Tiada Data</div>
    </div>
  );

  const getCoords = (percent) => [Math.cos(2 * Math.PI * percent), Math.sin(2 * Math.PI * percent)];
  const colors = ['#4F46E5', '#06B6D4', '#F59E0B', '#EC4899', '#10B981', '#8B5CF6']; 

  const slices = data.map((slice, i) => {
    const start = cumulativePercent;
    const slicePct = slice.value / total;
    cumulativePercent += slicePct;
    const [x1, y1] = getCoords(start);
    const [x2, y2] = getCoords(cumulativePercent);
    const large = slicePct > 0.5 ? 1 : 0;
    const path = slicePct === 1 ? `M 1 0 A 1 1 0 1 1 -1 0 A 1 1 0 1 1 1 0` : `M 0 0 L ${x1} ${y1} A 1 1 0 ${large} 1 ${x2} ${y2} L 0 0`;
    return { d: path, color: colors[i % colors.length], ...slice, pct: (slicePct * 100).toFixed(1) };
  });

  return (
    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center h-full transition hover:shadow-md">
      <h4 className="font-bold text-gray-800 mb-6 text-sm text-center uppercase tracking-wide">{title}</h4>
      <svg viewBox="-1.1 -1.1 2.2 2.2" className="w-40 h-40 transform -rotate-90 drop-shadow-sm">
        {slices.map((s, i) => <path key={i} d={s.d} fill={s.color} stroke="white" strokeWidth="0.03" />)}
      </svg>
      <div className="mt-6 w-full space-y-2 text-xs max-h-32 overflow-y-auto px-2 custom-scrollbar">
        {slices.map((s, i) => (
          <div key={i} className="flex justify-between items-center p-1 hover:bg-gray-50">
            <div className="flex items-center gap-2">
              <span className="w-3 h-3 rounded-full shadow-sm" style={{backgroundColor: s.color}}></span>
              <span className="truncate max-w-[120px] font-medium text-gray-600">{s.label}</span>
            </div>
            <span className="font-bold text-gray-800 bg-gray-100 px-2 py-0.5 rounded-full">{s.value} ({s.pct}%)</span>
          </div>
        ))}
      </div>
    </div>
  );
};

const AnnualTrendChart = ({ data }) => {
  const months = MONTH_NAMES_SHORT;
  const keys = [{k:'Coaching & Mentoring',c:'#4F46E5'},{k:'Kursus',c:'#10B981'},{k:'Bengkel',c:'#F59E0B'},{k:'Mesyuarat',c:'#EC4899'}];
  const max = Math.max(...data.flatMap(m => keys.map(x => m[x.k]||0))) || 1;

  return (
    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 overflow-x-auto">
      <h4 className="font-bold text-gray-800 mb-6 text-sm text-center uppercase tracking-wide">Trend Tahunan: 4 Fokus Utama</h4>
      <div className="flex items-end space-x-6 h-48 pb-2 min-w-[700px] px-4">
        {data.map((m, i) => (
          <div key={i} className="flex-1 flex flex-col justify-end items-center space-y-2 h-full">
            <div className="flex space-x-1 items-end h-full w-full justify-center">
              {keys.map(k => (
                <div key={k.k} className="w-3 rounded-t-md shadow-sm hover:opacity-80 transition-all" style={{height: `${((m[k.k]||0)/max)*100}%`, backgroundColor: k.c}} title={`${k.k}: ${m[k.k]||0}`} />
              ))}
            </div>
            <span className="text-[10px] font-bold text-gray-400 uppercase">{months[i]}</span>
          </div>
        ))}
      </div>
      <div className="flex justify-center gap-4 mt-4 text-xs border-t pt-4">
        {keys.map(k => <div key={k.k} className="flex items-center gap-2"><span className="w-3 h-3 rounded-full shadow-sm" style={{backgroundColor:k.c}}/> <span className="font-medium text-gray-600">{k.k}</span></div>)}
      </div>
    </div>
  );
};

// ==========================================
// 5. MODALS
// ==========================================

const AddPlaceModal = ({ isOpen, onClose, category }) => {
  const [newPlaceName, setNewPlaceName] = useState('');
  const [isAdding, setIsAdding] = useState(false);
  if (!isOpen) return null;
  const handleAdd = async (e) => {
    e.preventDefault(); if (!newPlaceName.trim()) return; setIsAdding(true);
    try { await addDoc(collection(db, COLLECTIONS.PLACES), { name: newPlaceName.trim().toUpperCase(), type: category }); setNewPlaceName(''); onClose(); } 
    catch (error) { alert("Ralat: " + error.message); } finally { setIsAdding(false); }
  };
  return (
    <div className="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
      <div className="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden animate-in fade-in zoom-in duration-200">
        <div className="bg-indigo-600 p-4"><h3 className="text-lg font-bold text-white flex items-center gap-2"><MapPin className="w-5 h-5"/> Tambah Tempat Baru</h3></div>
        <div className="p-6">
          <p className="text-sm text-gray-600 mb-4">Kategori: <span className="font-bold text-indigo-700">{category}</span></p>
          <form onSubmit={handleAdd}>
            <input type="text" autoFocus value={newPlaceName} onChange={(e) => setNewPlaceName(e.target.value)} className="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 mb-4 outline-none focus:border-indigo-500" placeholder="Contoh: SK PEKAN RANAU" />
            <div className="flex justify-end space-x-3">
              <button type="button" onClick={onClose} className="px-4 py-2 text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-lg font-medium" disabled={isAdding}>Batal</button>
              <button type="submit" className="px-4 py-2 bg-indigo-600 text-white hover:bg-indigo-700 rounded-lg font-medium shadow flex items-center gap-2" disabled={isAdding}>{isAdding ? <Loader2 className="w-4 h-4 animate-spin"/> : 'Simpan'}</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  );
};

const AddActivityTypeModal = ({ isOpen, onClose }) => {
  const [newActivityName, setNewActivityName] = useState('');
  const [isAdding, setIsAdding] = useState(false);
  if (!isOpen) return null;
  const handleAdd = async (e) => {
    e.preventDefault(); if (!newActivityName.trim()) return; setIsAdding(true);
    try { await addDoc(collection(db, COLLECTIONS.ACTIVITIES), { name: newActivityName.trim().toUpperCase() }); setNewActivityName(''); onClose(); } 
    catch (error) { alert("Ralat: " + error.message); } finally { setIsAdding(false); }
  };
  return (
    <div className="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
      <div className="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden animate-in fade-in zoom-in duration-200">
        <div className="bg-indigo-600 p-4"><h3 className="text-lg font-bold text-white flex items-center gap-2"><List className="w-5 h-5"/> Tambah Perkara Baru</h3></div>
        <div className="p-6">
          <p className="text-sm text-gray-600 mb-4">Masukkan jenis aktiviti baru.</p>
          <form onSubmit={handleAdd}>
            <input type="text" autoFocus value={newActivityName} onChange={(e) => setNewActivityName(e.target.value)} className="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 mb-4 outline-none focus:border-indigo-500" placeholder="Nama Perkara" />
            <div className="flex justify-end space-x-3">
              <button type="button" onClick={onClose} className="px-4 py-2 text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-lg font-medium" disabled={isAdding}>Batal</button>
              <button type="submit" className="px-4 py-2 bg-indigo-600 text-white hover:bg-indigo-700 rounded-lg font-medium shadow flex items-center gap-2" disabled={isAdding}>{isAdding ? <Loader2 className="w-4 h-4 animate-spin"/> : 'Simpan'}</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  );
};

const DeleteConfirmationModal = ({ isOpen, onClose, onConfirm, itemName, isDeleting }) => {
  if (!isOpen) return null;
  return (
    <div className="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 p-4 backdrop-blur-sm animate-in fade-in duration-200">
      <div className="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden transform scale-100 transition-all">
        <div className="p-6 text-center">
          <div className="w-12 h-12 bg-red-100 text-red-600 rounded-full flex items-center justify-center mx-auto mb-4"><Trash2 className="w-6 h-6" /></div>
          <h3 className="text-lg font-bold text-gray-900 mb-2">Padam Data?</h3>
          <p className="text-sm text-gray-500 mb-6">Adakah anda pasti mahu memadam <span className="font-bold text-gray-800">"{itemName}"</span>? Tindakan ini tidak boleh dibatalkan.</p>
          <div className="flex justify-center space-x-3">
            <button onClick={onClose} disabled={isDeleting} className="px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg font-medium text-sm transition">Batal</button>
            <button onClick={onConfirm} disabled={isDeleting} className="px-4 py-2 bg-red-600 text-white hover:bg-red-700 rounded-lg font-medium text-sm shadow-md hover:shadow-lg transition flex items-center gap-2">{isDeleting ? <Loader2 className="w-4 h-4 animate-spin" /> : 'Padam'}</button>
          </div>
        </div>
      </div>
    </div>
  );
};

// ==========================================
// 6. ADMIN COMPONENTS
// ==========================================

const AdminDataMgmt = ({ staff, places, activities }) => {
  const [val, setVal] = useState(''); 
  const [cat, setCat] = useState('Sekolah Rendah'); 
  const [type, setType] = useState('place'); 
  const [deleteModal, setDeleteModal] = useState({ isOpen: false, coll: null, id: null, name: '' });
  const [isDeleting, setIsDeleting] = useState(false);

  const initiateDelete = (coll, id, name) => setDeleteModal({ isOpen: true, coll, id, name });

  const confirmDelete = async () => {
    if (!deleteModal.coll || !deleteModal.id) return;
    setIsDeleting(true);
    try {
      await deleteDoc(doc(db, deleteModal.coll, deleteModal.id));
      setDeleteModal({ isOpen: false, coll: null, id: null, name: '' });
    } catch (e) { alert("Ralat semasa memadam: " + e.message); } finally { setIsDeleting(false); }
  };

  const add = async (e) => { e.preventDefault(); if(!val) return; const coll = type === 'place' ? COLLECTIONS.PLACES : COLLECTIONS.ACTIVITIES; const data = type === 'place' ? { name: val.toUpperCase(), type: cat } : { name: val.toUpperCase() }; await addDoc(collection(db, coll), data); setVal(''); };

  return (
    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8 relative">
      <DeleteConfirmationModal isOpen={deleteModal.isOpen} onClose={() => setDeleteModal({ ...deleteModal, isOpen: false })} onConfirm={confirmDelete} itemName={deleteModal.name} isDeleting={isDeleting} />
      <div className="bg-white p-6 rounded-xl shadow-sm border border-pink-100"><h3 className="font-bold text-pink-800 mb-4 flex items-center gap-2"><Users className="w-5 h-5"/> Staf</h3><ul className="h-72 overflow-y-auto text-sm divide-y divide-pink-50 pr-2 custom-scrollbar">{staff.map(s => <li key={s.id} className="flex justify-between p-3 hover:bg-pink-50 rounded-lg"><span>{s.name}</span><button onClick={() => initiateDelete(COLLECTIONS.STAFF, s.id, s.name)} className="text-red-400 hover:text-red-600"><Trash2 className="w-4 h-4"/></button></li>)}</ul></div>
      <div className="bg-white p-6 rounded-xl shadow-sm border border-blue-100"><h3 className="font-bold text-blue-800 mb-4 flex items-center gap-2"><MapPin className="w-5 h-5"/> Tempat</h3>
        <form onSubmit={(e) => { setType('place'); add(e); }} className="mb-4 flex flex-col gap-3 bg-blue-50 p-3 rounded-lg">
          <input value={val} onChange={e => setVal(e.target.value)} className="border p-2 rounded-md text-sm outline-none focus:border-blue-500" placeholder="Nama Tempat" />
          <select value={cat} onChange={e => setCat(e.target.value)} className="border p-2 rounded-md text-sm outline-none focus:border-blue-500"><option>Sekolah Rendah</option><option>Sekolah Menengah</option><option>Pejabat</option><option>Lain-lain</option></select>
          <button className="bg-blue-600 text-white py-2 rounded-md text-sm font-bold hover:bg-blue-700 transition">Tambah</button>
        </form>
        <ul className="h-48 overflow-y-auto text-sm divide-y divide-blue-50 pr-2 custom-scrollbar">{places.map(p => <li key={p.id} className="flex justify-between p-2 hover:bg-blue-50 rounded"><span className="truncate">{p.name} <i className="text-xs text-gray-400 block">{p.type}</i></span><button onClick={() => initiateDelete(COLLECTIONS.PLACES, p.id, p.name)} className="text-red-400 hover:text-red-600"><Trash2 className="w-4 h-4"/></button></li>)}</ul>
      </div>
      <div className="bg-white p-6 rounded-xl shadow-sm border border-green-100"><h3 className="font-bold text-green-800 mb-4 flex items-center gap-2"><List className="w-5 h-5"/> Perkara</h3>
        <form onSubmit={(e) => { setType('activity'); add(e); }} className="mb-4 flex gap-2 bg-green-50 p-3 rounded-lg">
          <input value={val} onChange={e => setVal(e.target.value)} className="border p-2 rounded-md text-sm flex-1 outline-none focus:border-green-500" placeholder="Nama Perkara" /><button className="bg-green-600 text-white px-4 rounded-md text-sm font-bold hover:bg-green-700 transition"><Plus className="w-4 h-4"/></button>
        </form>
        <ul className="h-72 overflow-y-auto text-sm divide-y divide-green-50 pr-2 custom-scrollbar">{activities.map(a => <li key={a.id} className="flex justify-between p-3 hover:bg-green-50 rounded-lg"><span>{a.name}</span><button onClick={() => initiateDelete(COLLECTIONS.ACTIVITIES, a.id, a.name)} className="text-red-400 hover:text-red-600"><Trash2 className="w-4 h-4"/></button></li>)}</ul>
      </div>
    </div>
  );
};

const AdminStaffAnalysis = ({ logs, staff }) => {
  const [viewMonth, setViewMonth] = useState(new Date().toISOString().slice(0, 7));
  const [sName, setSName] = useState(''); const [sDate, setSDate] = useState(''); const [sPlace, setSPlace] = useState(''); const [sAct, setSAct] = useState(''); const [sNote, setSNote] = useState('');
  
  const missingReport = useMemo(() => {
    if (!staff.length) return [];
    const [y, m] = viewMonth.split('-').map(Number); const days = getDaysInMonth(y, m); const report = [];
    staff.forEach(s => { const sLogs = logs.filter(l => l.staffName === s.name); const missed = []; days.forEach(day => { if (!sLogs.some(l => formatDate(l.timestamp) === formatDate(day))) missed.push(day.getDate()); }); if (missed.length > 0) report.push({ name: s.name, days: missed }); });
    return report;
  }, [viewMonth, logs, staff]);

  const filteredLogs = useMemo(() => logs.filter(l => {
    if (sName && l.staffName !== sName) return false; if (sDate && formatDate(l.timestamp) !== sDate) return false;
    if (sPlace && !l.placeName.toLowerCase().includes(sPlace.toLowerCase())) return false;
    if (sAct && !l.activityType.toLowerCase().includes(sAct.toLowerCase())) return false;
    if (sNote && !l.notes.toLowerCase().includes(sNote.toLowerCase())) return false;
    return true;
  }), [logs, sName, sDate, sPlace, sAct, sNote]);

  return (
    <div className="space-y-8">
      <div className="bg-white p-6 rounded-xl shadow-sm border border-red-100"><div className="flex justify-between items-center mb-6"><h3 className="text-lg font-bold text-red-700 flex items-center gap-2"><LogOut className="w-5 h-5"/> Semakan Ketidakhadiran Log</h3><input type="month" value={viewMonth} onChange={e => setViewMonth(e.target.value)} className="border p-2 rounded-lg text-sm outline-none focus:border-red-300" /></div>
        <div className="overflow-x-auto max-h-64 border border-red-100 rounded-lg custom-scrollbar"><table className="w-full text-sm text-left divide-y divide-red-50"><thead className="bg-red-50 text-red-900 sticky top-0"><tr><th className="p-3">Nama Staf</th><th className="p-3">Tarikh (Hari)</th></tr></thead><tbody className="divide-y divide-red-50 bg-white">{missingReport.map((r, i) => <tr key={i} className="hover:bg-red-50"><td className="p-3 font-medium text-gray-700">{r.name}</td><td className="p-3 text-red-600 text-xs">{r.days.join(', ')}</td></tr>)}</tbody></table></div>
      </div>
      <div className="bg-white p-6 rounded-xl shadow-sm border border-indigo-100"><h3 className="text-lg font-bold text-indigo-800 mb-6 flex items-center gap-2"><Search className="w-5 h-5"/> Pemantauan Pergerakan</h3>
        <div className="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6 bg-indigo-50 p-4 rounded-xl border border-indigo-100">
          <select value={sName} onChange={e => setSName(e.target.value)} className="p-2 border rounded-lg text-xs outline-none focus:border-indigo-500"><option value="">Semua Staf</option>{[...new Set(staff.map(s => s.name))].sort().map(n => <option key={n} value={n}>{n}</option>)}</select>
          <input type="date" value={sDate} onChange={e => setSDate(e.target.value)} className="p-2 border rounded-lg text-xs outline-none focus:border-indigo-500" />
          <input placeholder="Cari Tempat..." value={sPlace} onChange={e => setSPlace(e.target.value)} className="p-2 border rounded-lg text-xs outline-none focus:border-indigo-500" />
          <input placeholder="Cari Perkara..." value={sAct} onChange={e => setSAct(e.target.value)} className="p-2 border rounded-lg text-xs outline-none focus:border-indigo-500" />
          <input placeholder="Cari Catatan..." value={sNote} onChange={e => setSNote(e.target.value)} className="p-2 border rounded-lg text-xs outline-none focus:border-indigo-500" />
        </div>
        <div className="overflow-x-auto max-h-96 border border-gray-200 rounded-lg custom-scrollbar"><table className="w-full text-xs text-left divide-y divide-gray-200"><thead className="bg-gray-50 sticky top-0"><tr><th className="p-3">Tarikh</th><th className="p-3">Nama</th><th className="p-3">Tempat</th><th className="p-3">Perkara</th><th className="p-3">Catatan</th></tr></thead><tbody className="divide-y divide-gray-100 bg-white">{filteredLogs.map(l => <tr key={l.id} className="hover:bg-indigo-50"><td className="p-3 whitespace-nowrap text-gray-500">{new Date(l.timestamp).toLocaleDateString('ms-MY')}</td><td className="p-3 font-bold text-gray-800">{l.staffName}</td><td className="p-3">{l.placeName} <span className="text-[10px] text-gray-400 block">{l.placeType}</span></td><td className="p-3"><span className="bg-blue-100 text-blue-800 px-2 py-1 rounded-full">{l.activityType}</span></td><td className="p-3 italic text-gray-500 truncate max-w-xs">{l.notes}</td></tr>)}</tbody></table></div>
      </div>
    </div>
  );
};

const AdminOverall = ({ logs }) => {
  const [month, setMonth] = useState(new Date().toISOString().slice(0, 7)); const currentYear = new Date().getFullYear();
  const monthlyData = useMemo(() => {
    const filtered = logs.filter(l => formatDate(l.timestamp).startsWith(month));
    const act = {}, plc = {}; filtered.forEach(l => { act[l.activityType] = (act[l.activityType]||0)+1; plc[l.placeType] = (plc[l.placeType]||0)+1; });
    return { act: Object.entries(act).map(([label, value]) => ({label, value})), plc: Object.entries(plc).map(([label, value]) => ({label, value})), total: filtered.length };
  }, [logs, month]);
  const annualData = useMemo(() => {
    const data = Array(12).fill(0).map(() => ({}));
    logs.filter(l => new Date(l.timestamp).getFullYear() === currentYear).forEach(l => {
      const m = new Date(l.timestamp).getMonth(); let k=null; const t=(l.activityType||'').toLowerCase();
      if(t.includes('coaching')) k='Coaching & Mentoring'; else if(t.includes('kursus')) k='Kursus'; else if(t.includes('bengkel')) k='Bengkel'; else if(t.includes('mesyuarat')) k='Mesyuarat';
      if(k) data[m][k] = (data[m][k]||0)+1;
    });
    return data;
  }, [logs, currentYear]);

  return (
    <div className="space-y-8">
      <div className="bg-white p-6 rounded-xl shadow-sm border border-blue-100"><div className="flex justify-between items-center mb-6"><h3 className="text-blue-800 font-bold text-lg flex items-center gap-2"><PieChart className="w-5 h-5"/> Analisis Bulanan (Total: {monthlyData.total})</h3><input type="month" value={month} onChange={e => setMonth(e.target.value)} className="border p-2 rounded-lg text-sm outline-none focus:border-blue-500" /></div><div className="grid grid-cols-1 md:grid-cols-2 gap-8 h-72"><SimplePieChart data={monthlyData.plc} title="Kategori Tempat" /><SimplePieChart data={monthlyData.act} title="Perkara / Fokus" /></div></div>
      <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200"><h3 className="font-bold text-gray-800 mb-6 text-lg flex items-center gap-2"><TrendingUp className="w-5 h-5"/> Analisis Tahunan {currentYear} (4 Fokus Utama)</h3><AnnualTrendChart data={annualData} /></div>
    </div>
  );
};

const AdminLeaderboard = ({ logs }) => {
  const [month, setMonth] = useState(new Date().toISOString().slice(0, 7));
  const leaderboard = useMemo(() => {
    const stats = {};
    logs.filter(l => formatDate(l.timestamp).startsWith(month)).forEach(l => {
      const name = l.staffName; if(!name) return; if(!stats[name]) stats[name] = {name, total:0, cm:0};
      stats[name].total++; if((l.activityType||'').toLowerCase().includes('coaching')||(l.activityType||'').toLowerCase().includes('mentoring')) stats[name].cm++;
    });
    const all = Object.values(stats);
    return { topLogs: [...all].sort((a,b)=>b.total-a.total).slice(0,5), topCM: [...all].sort((a,b)=>b.cm-a.cm).slice(0,5) };
  }, [logs, month]);

  return (
    <div className="space-y-8">
       <div className="flex justify-between items-center bg-white p-4 rounded-xl border border-gray-200 shadow-sm"><h3 className="font-bold text-gray-800 flex items-center gap-2"><Award className="w-5 h-5 text-yellow-500"/> Papan Pendahulu (Leaderboard)</h3><input type="month" value={month} onChange={e => setMonth(e.target.value)} className="border p-2 rounded-lg text-sm outline-none focus:border-yellow-500" /></div>
       <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
        <div className="bg-gradient-to-br from-yellow-50 to-orange-50 p-6 rounded-xl border border-yellow-200 shadow-sm"><h3 className="font-bold text-yellow-800 mb-4 text-lg flex items-center gap-2">ðŸŒŸ Top Penggerak Utama</h3><ul className="space-y-3">{leaderboard.topLogs.map((s,i)=><li key={s.name} className="flex justify-between items-center bg-white p-3 rounded-lg shadow-sm"><div className="flex items-center gap-3"><span className={`w-8 h-8 flex items-center justify-center rounded-full font-bold ${i===0?'bg-yellow-400 text-white':i===1?'bg-gray-300 text-gray-700':i===2?'bg-orange-300 text-white':'bg-gray-100 text-gray-500'}`}>{i+1}</span><span className="font-bold text-gray-700">{s.name}</span></div><span className="font-extrabold text-yellow-600 text-lg">{s.total}</span></li>)}</ul></div>
        <div className="bg-gradient-to-br from-blue-50 to-indigo-50 p-6 rounded-xl border border-blue-200 shadow-sm"><h3 className="font-bold text-blue-800 mb-4 text-lg flex items-center gap-2">ðŸŽ“ Juara C&M</h3><ul className="space-y-3">{leaderboard.topCM.map((s,i)=><li key={s.name} className="flex justify-between items-center bg-white p-3 rounded-lg shadow-sm"><div className="flex items-center gap-3"><span className={`w-8 h-8 flex items-center justify-center rounded-full font-bold ${i===0?'bg-blue-500 text-white':i===1?'bg-blue-400 text-white':i===2?'bg-blue-300 text-white':'bg-gray-100 text-gray-500'}`}>{i+1}</span><span className="font-bold text-gray-700">{s.name}</span></div><span className="font-extrabold text-blue-600 text-lg">{s.cm}</span></li>)}</ul></div>
       </div>
    </div>
  );
};

// ==========================================
// 7. STAFF COMPONENTS
// ==========================================

const StaffLogForm = ({ userId, userProfile, places, activities }) => {
  const [form, setForm] = useState({ date: formatDate(new Date()), time: new Date().toTimeString().slice(0, 5), placeName: '', placeType: 'Pejabat', activityType: '', notes: '' });
  const [cat, setCat] = useState('Pejabat'); const [submitting, setSubmitting] = useState(false);
  const [showPlaceModal, setShowPlaceModal] = useState(false); const [showActivityModal, setShowActivityModal] = useState(false);
  const [manualTime, setManualTime] = useState(false);
  const filteredPlaces = places.filter(p => p.type === cat);

  const handleDateChange = (e) => {
    const newDate = e.target.value; const today = formatDate(new Date()); let newTime = "08:00";
    if (newDate === today) newTime = new Date().toTimeString().slice(0, 5);
    setForm(prev => ({ ...prev, date: newDate, time: newTime }));
  };

  const submit = async (e) => {
    e.preventDefault(); if (!form.placeName || !form.activityType) return alert("Sila lengkapkan borang."); setSubmitting(true);
    try { 
      const timestamp = new Date(`${form.date}T${form.time}`);
      await addDoc(collection(db, COLLECTIONS.LOGS), { ...form, staffName: userProfile.fullName, userId, timestamp }); 
      setForm(p => ({ ...p, placeName: '', activityType: '', notes: '' })); 
      const isFuture = new Date(form.date) > new Date(formatDate(new Date()));
      alert(isFuture ? "Pergerakan berjaya dijadualkan." : "Log berjaya dihantar.");
    } catch (e) { alert("Ralat: " + e.message); } 
    setSubmitting(false);
  };

  const isFutureDate = useMemo(() => new Date(form.date) > new Date(formatDate(new Date())), [form.date]);

  return (
    <div className="bg-white p-8 rounded-xl shadow-lg border border-indigo-100 relative overflow-hidden">
      <AddPlaceModal isOpen={showPlaceModal} onClose={() => setShowPlaceModal(false)} category={cat} />
      <AddActivityTypeModal isOpen={showActivityModal} onClose={() => setShowActivityModal(false)} />
      <div className={`absolute top-0 left-0 w-full h-2 bg-gradient-to-r ${isFutureDate ? 'from-green-500 to-teal-500' : 'from-indigo-500 to-purple-500'}`}></div>
      <h2 className="font-bold text-xl mb-6 text-indigo-900 flex items-center gap-2">{isFutureDate ? <Calendar className="w-6 h-6 text-green-600"/> : <FileText className="w-6 h-6 text-indigo-600"/>} {isFutureDate ? 'Jadual Pergerakan (Advance)' : 'Log Harian'}</h2>
      <form onSubmit={submit} className="space-y-5 text-sm">
        <div>
          <div className="flex justify-between items-center mb-1.5"><label className="block font-bold text-gray-700">1. Tarikh & Masa</label><button type="button" onClick={() => setManualTime(!manualTime)} className={`text-xs flex items-center gap-1 font-semibold px-2 py-1 rounded transition ${manualTime ? 'bg-indigo-100 text-indigo-700' : 'text-gray-400 hover:text-gray-600'}`}><Clock className="w-3 h-3" /> {manualTime ? 'Tetapkan Masa' : 'Tetapkan Masa?'}</button></div>
          <div className="flex gap-2"><input type="date" value={form.date} onChange={handleDateChange} className="flex-1 border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition" required /><input type="time" value={form.time} onChange={e => setForm({...form, time: e.target.value})} className="w-32 border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition" required /></div>
          <p className="text-xs text-gray-400 mt-1">{isFutureDate ? 'Log ini akan direkodkan sebagai pergerakan akan datang.' : 'Rekod log semasa atau terdahulu (backdated).'}</p>
        </div>
        <div className="bg-gray-50 p-4 rounded-lg border border-gray-200"><label className="block font-bold text-gray-700 mb-3">2. Tempat ({cat})</label><div className="flex flex-wrap gap-2 mb-3">{['Pejabat','Sekolah Rendah','Sekolah Menengah','Lain-lain'].map(c => <button key={c} type="button" onClick={() => {setCat(c); setForm({...form, placeType: c, placeName: ''})}} className={`px-3 py-1.5 rounded-md text-xs font-bold border transition ${cat===c ? 'bg-indigo-600 text-white border-indigo-600 shadow-md' : 'bg-white text-gray-600 border-gray-300 hover:bg-gray-100'}`}>{c}</button>)}</div><div className="flex gap-2"><select value={form.placeName} onChange={e => setForm({...form, placeName: e.target.value})} className="w-full border border-gray-300 p-3 rounded-lg bg-white focus:ring-2 focus:ring-indigo-500 outline-none"><option value="">-- Pilih Tempat --</option>{filteredPlaces.map(p => <option key={p.id} value={p.name}>{p.name}</option>)}</select><button type="button" onClick={() => setShowPlaceModal(true)} className="bg-green-600 text-white px-3 rounded-lg font-bold text-lg hover:bg-green-700 transition">+</button></div></div>
        <div><label className="block font-bold text-gray-700 mb-1.5">3. Perkara / Fokus</label><div className="flex gap-2"><select value={form.activityType} onChange={e => setForm({...form, activityType: e.target.value})} className="w-full border border-gray-300 p-3 rounded-lg bg-white focus:ring-2 focus:ring-indigo-500 outline-none"><option value="">-- Pilih --</option>{activities.map(a => <option key={a.id} value={a.name}>{a.name}</option>)}</select><button type="button" onClick={() => setShowActivityModal(true)} className="bg-green-600 text-white px-3 rounded-lg font-bold text-lg hover:bg-green-700 transition">+</button></div></div>
        <div><label className="block font-bold text-gray-700 mb-1.5">4. Catatan</label><textarea rows="3" value={form.notes} onChange={e => setForm({...form, notes: e.target.value})} className="w-full border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="Perincian aktiviti..." /></div>
        <button disabled={submitting} className={`w-full bg-gradient-to-r ${isFutureDate ? 'from-green-600 to-teal-600 hover:from-green-700 hover:to-teal-700' : 'from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700'} text-white p-4 rounded-lg font-bold text-base hover:shadow-lg hover:scale-[1.01] transition transform duration-200`}>{submitting ? <ButtonSpinner text="Memproses..." /> : (isFutureDate ? "Jadualkan Pergerakan" : "Hantar Log")}</button>
      </form>
    </div>
  );
};

const StaffIndividualAnalysis = ({ myLogs }) => {
  const currentYear = new Date().getFullYear(); const currentMonth = new Date().getMonth() + 1;
  const [fDay, setFDay] = useState(''); const [fMonth, setFMonth] = useState(currentMonth.toString().padStart(2,'0')); const [fYear, setFYear] = useState(currentYear.toString());
  
  const filtered = useMemo(() => myLogs.filter(l => {
    const d = new Date(l.timestamp);
    if(fYear && d.getFullYear() !== parseInt(fYear)) return false; if(fMonth && (d.getMonth()+1) !== parseInt(fMonth)) return false; if(fDay && d.getDate() !== parseInt(fDay)) return false;
    return true;
  }), [myLogs, fYear, fMonth, fDay]);
  
  const stats = useMemo(() => {
    const act = {}, plc = {}; filtered.forEach(l => { act[l.activityType]=(act[l.activityType]||0)+1; plc[l.placeType]=(plc[l.placeType]||0)+1; });
    return { act: Object.entries(act).map(([label, value]) => ({label, value})), plc: Object.entries(plc).map(([label, value]) => ({label, value})), total: filtered.length };
  }, [filtered]);

  return (
    <div className="space-y-6 bg-white p-6 rounded-xl shadow-sm border border-teal-100">
      <div className="bg-teal-50 p-3 rounded grid grid-cols-3 gap-3 mb-3">
        <select value={fDay} onChange={e => setFDay(e.target.value)} className="border p-2 rounded text-xs focus:border-teal-500"><option value="">Semua Hari</option>{Array.from({length:31},(_,i)=><option key={i+1} value={i+1}>{i+1}</option>)}</select>
        <select value={fMonth} onChange={e => setFMonth(e.target.value)} className="border p-2 rounded text-xs focus:border-teal-500"><option value="">Semua Bulan</option>{MONTH_NAMES_SHORT.map((m,i)=><option key={i} value={(i+1).toString().padStart(2,'0')}>{m}</option>)}</select>
        <select value={fYear} onChange={e => setFYear(e.target.value)} className="border p-2 rounded text-xs focus:border-teal-500"><option value="">Semua Tahun</option>{Array.from({length:3},(_,i)=><option key={i} value={currentYear-i}>{currentYear-i}</option>)}</select>
      </div>
      <p className="text-center font-bold text-teal-800">Jumlah Saringan: {stats.total}</p><div className="grid grid-cols-1 md:grid-cols-2 gap-6 h-56"><SimplePieChart data={stats.act} title="Perkara" /><SimplePieChart data={stats.plc} title="Tempat" /></div>
      <div className="overflow-x-auto border border-teal-100 rounded-lg max-h-64 custom-scrollbar"><table className="w-full text-xs text-left divide-y divide-teal-50"><thead className="bg-teal-50 font-bold text-teal-700 sticky top-0"><tr><th className="p-3">Tarikh</th><th className="p-3">Perkara</th><th className="p-3">Tempat</th><th className="p-3">Catatan</th></tr></thead><tbody className="divide-y divide-teal-50 bg-white">{filtered.map(l => <tr key={l.id} className="hover:bg-teal-50"><td className="p-3">{new Date(l.timestamp).toLocaleDateString('ms-MY')}</td><td className="p-3 font-bold text-indigo-600">{l.activityType}</td><td className="p-3">{l.placeName}</td><td className="p-3 italic text-gray-500 truncate max-w-xs">{l.notes}</td></tr>)}</tbody></table></div>
    </div>
  );
};

const StaffGuidanceAnalysis = ({ myLogs }) => {
  const [month, setMonth] = useState(new Date().toISOString().slice(0, 7)); const currentYear = new Date().getFullYear();
  const monthly = useMemo(() => myLogs.filter(l => formatDate(l.timestamp).startsWith(month)), [myLogs, month]);
  const yearly = useMemo(() => myLogs.filter(l => new Date(l.timestamp).getFullYear() === currentYear), [myLogs, currentYear]);
  const genPie = (logs, k) => Object.entries(logs.reduce((a,c)=>{a[c[k]]=(a[c[k]]||0)+1; return a},{})).map(([label,value])=>({label,value}));
  const annualData = useMemo(() => {
    const d = Array(12).fill(0).map(() => ({})); yearly.forEach(l => { const m = new Date(l.timestamp).getMonth(); let k=null; const t=(l.activityType||'').toLowerCase(); if(t.includes('coaching')) k='Coaching & Mentoring'; else if(t.includes('kursus')) k='Kursus'; else if(t.includes('bengkel')) k='Bengkel'; else if(t.includes('mesyuarat')) k='Mesyuarat'; if(k) d[m][k] = (d[m][k]||0)+1; }); return d;
  }, [yearly]);
  const mStats = { place: genPie(monthly, 'placeType'), act: genPie(monthly, 'activityType'), total: monthly.length };
  return (
    <div className="space-y-8">
      <div className="bg-white p-6 rounded shadow border-blue-100"><div className="flex justify-between mb-4"><h3 className="text-blue-700 font-bold flex items-center gap-2"><TrendingUp className="w-5 h-5"/> Analisis Bulanan ({mStats.total})</h3><input type="month" value={month} onChange={e => setMonth(e.target.value)} className="border p-1 rounded text-xs outline-none focus:border-blue-500" /></div><div className="grid grid-cols-1 md:grid-cols-2 gap-6 h-64"><SimplePieChart data={mStats.place} title="Tempat" /><SimplePieChart data={mStats.act} title="Perkara" /></div></div>
      <div className="bg-white p-6 rounded shadow border-gray-200"><h3 className="font-bold text-gray-700 mb-4 flex items-center gap-2"><BarChart2 className="w-5 h-5"/> Kemajuan Tahunan (4 Fokus Utama)</h3><AnnualTrendChart data={annualData} /></div>
    </div>
  );
};

const StaffListMonth = ({ logs, profile }) => {
  const [month, setMonth] = useState(new Date().toISOString().slice(0, 7));
  const data = useMemo(() => logs.filter(l => l.staffName === profile.fullName && formatDate(l.timestamp).startsWith(month)).sort((a, b) => b.timestamp - a.timestamp), [logs, profile, month]);
  return (
    <div className="bg-white p-6 rounded shadow border-purple-100 border">
      <div className="flex justify-between items-center mb-4 no-print">
        <h2 className="text-purple-800 font-bold flex items-center gap-2"><Calendar className="w-5 h-5"/> Senarai Bulanan</h2>
        <div className="flex gap-2"><input type="month" value={month} onChange={e => setMonth(e.target.value)} className="border p-1 rounded text-sm outline-none focus:border-purple-500"/><button onClick={() => window.print()} className="bg-gray-200 px-3 py-1 rounded text-xs font-bold hover:bg-gray-300 transition">Cetak</button><button onClick={() => downloadCSV(data, `Log.csv`)} className="bg-green-600 text-white px-3 py-1 rounded text-xs font-bold hover:bg-green-700 transition">Excel</button></div>
      </div>
      <div className="hidden print:block text-center mb-6"><h1 className="text-xl font-bold">Laporan: {profile.fullName}</h1><p>{month}</p></div>
      <div className="overflow-x-auto border rounded custom-scrollbar"><table className="w-full text-xs text-left divide-y"><thead className="bg-purple-50 font-bold text-purple-900"><tr><th className="p-3">Tarikh</th><th className="p-3">Tempat</th><th className="p-3">Perkara/Fokus</th><th className="p-3">Catatan</th></tr></thead><tbody className="divide-y">{data.map(l => <tr key={l.id} className="hover:bg-purple-50"><td className="p-3">{new Date(l.timestamp).toLocaleDateString('ms-MY')}</td><td className="p-3">{l.placeName}<br/><span className="text-[10px] text-gray-400">{l.placeType}</span></td><td className="p-3 font-bold text-indigo-600">{l.activityType}</td><td className="p-3 italic text-gray-500">{l.notes}</td></tr>)}</tbody></table></div>
    </div>
  );
};

// ==========================================
// 8. AUTH PAGE & MAIN APP
// ==========================================

const AuthPage = ({ register, login }) => {
  const [isReg, setReg] = useState(false); const [d, setD] = useState({ u: '', p: '', n: '', j: '' }); const [msg, setMsg] = useState(''); const [load, setLoad] = useState(false);
  const sub = async (e) => { e.preventDefault(); setMsg(''); setLoad(true); try { if (isReg) await register(d.u, d.p, d.n, d.j); else await login(d.u, d.p); } catch (err) { setMsg(err.message); } setLoad(false); };
  return (
    <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-indigo-500 to-purple-600 p-4">
      <div className="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md animate-in fade-in zoom-in duration-300">
        <div className="text-center mb-8"><h1 className="text-3xl font-extrabold text-gray-800 tracking-tight mb-1">{isReg ? 'Pendaftaran' : 'Selamat Datang'}</h1></div>
        {msg && <div className="bg-red-50 text-red-600 p-3 rounded-lg mb-6 text-sm font-medium text-center border border-red-100 flex items-center justify-center gap-2"><X className="w-4 h-4"/> {msg}</div>}
        <form onSubmit={sub} className="space-y-5">
          <div><label className="block text-xs font-bold text-gray-600 uppercase mb-1 ml-1">ID Pengguna</label><input placeholder="ali" value={d.u} onChange={e => setD({...d, u: e.target.value})} className="w-full border p-3 rounded-xl outline-none focus:border-indigo-500 transition" required /></div>
          {isReg && <><div><label className="block text-xs font-bold text-gray-600 uppercase mb-1 ml-1">Nama Penuh</label><input placeholder="ALI BIN ABU" value={d.n} onChange={e => setD({...d, n: e.target.value.toUpperCase()})} className="w-full border p-3 rounded-xl outline-none focus:border-indigo-500 transition" required /></div><div><label className="block text-xs font-bold text-gray-600 uppercase mb-1 ml-1">Jawatan</label><input placeholder="PEGAWAI" value={d.j} onChange={e => setD({...d, j: e.target.value.toUpperCase()})} className="w-full border p-3 rounded-xl outline-none focus:border-indigo-500 transition" required /></div></>}
          <div><label className="block text-xs font-bold text-gray-600 uppercase mb-1 ml-1">Kata Laluan</label><input type="password" placeholder="â€¢â€¢â€¢â€¢" value={d.p} onChange={e => setD({...d, p: e.target.value})} className="w-full border p-3 rounded-xl outline-none focus:border-indigo-500 transition" required /></div>
          <button disabled={load} className="w-full bg-indigo-600 text-white p-3.5 rounded-xl font-bold text-lg shadow-lg hover:shadow-xl hover:bg-indigo-700 transition transform active:scale-95">{load ? <ButtonSpinner text="Memproses..." /> : (isReg ? 'Daftar Akaun' : 'Log Masuk')}</button>
        </form>
        <div className="mt-6 text-center"><button onClick={() => { setReg(!isReg); setMsg(''); }} className="text-sm text-indigo-600 font-semibold hover:underline">{isReg ? "Sudah ada akaun? Log Masuk" : "Tiada akaun? Daftar Sekarang"}</button></div>
      </div>
    </div>
  );
};

export default function App() {
  const { userId, user, loading: authLoad } = useAuth();
  const { role, isAuthenticated, profile, checking, register, login, logout } = useUserCredentials(userId);
  const staffs = useDataCollection(COLLECTIONS.STAFF, user); 
  const places = useDataCollection(COLLECTIONS.PLACES, user); 
  const activities = useDataCollection(COLLECTIONS.ACTIVITIES, user); 
  const { logs, loading: dataLoad } = useLogs(user);
  
  const [adminTab, setAdminTab] = useState('data'); 
  const [staffTab, setStaffTab] = useState('log');

  // SAFETY LOADER: Injects Tailwind CSS if missing (Fixes ReferenceError)
  useEffect(() => {
    const existingScript = document.querySelector('script[src="https://cdn.tailwindcss.com"]');
    if (!existingScript) {
      const script = document.createElement('script');
      script.src = "https://cdn.tailwindcss.com";
      document.head.appendChild(script);
    }
  }, []);

  if (authLoad || checking) return <LoadingScreen />;
  if (!isAuthenticated) return <AuthPage register={register} login={login} />;

  return (
    <div className="min-h-screen bg-gray-50 text-gray-800 font-sans">
      <header className="bg-white shadow-sm sticky top-0 z-50 border-b border-gray-100 no-print">
        <div className="max-w-6xl mx-auto px-4 h-16 flex justify-between items-center">
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 bg-indigo-600 rounded-lg flex items-center justify-center text-white font-bold text-xl shadow">P</div>
            <div><h1 className="text-lg font-extrabold text-gray-800 tracking-tight leading-tight">eGerak SPb Ranau</h1><p className="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Sektor Pembelajaran</p></div>
          </div>
          <div className="flex items-center gap-4">
            <div className="text-right hidden sm:block">
              <p className="text-sm font-bold text-gray-700">{profile?.fullName}</p>
              <p className="text-xs text-indigo-500 font-medium uppercase">{role === 'admin' ? 'Pentadbir' : 'Staf'}</p>
            </div>
            <button onClick={logout} className="bg-red-50 text-red-600 p-2 rounded-lg hover:bg-red-100 transition"><LogOut className="w-5 h-5"/></button>
          </div>
        </div>
      </header>
      
      <main className="max-w-6xl mx-auto p-4 md:p-6">
        {dataLoad ? <LoadingMessage message="Menyelaraskan data..." /> : (
          role === 'admin' ? (
            <div className="space-y-6">
              <div className="flex bg-gray-200 p-1.5 rounded-xl shadow-inner overflow-x-auto">
                {[
                  {id:'data',l:'Pengurusan Data', i:<Users className="w-4 h-4"/>},
                  {id:'staff',l:'Laporan Staf', i:<FileText className="w-4 h-4"/>},
                  {id:'overall',l:'Analisis Keseluruhan', i:<PieChart className="w-4 h-4"/>},
                  {id:'ranking',l:'Ranking', i:<Award className="w-4 h-4"/>}
                ].map(t => (
                  <button key={t.id} onClick={()=>setAdminTab(t.id)} className={`flex-1 py-2.5 px-2 text-xs font-bold rounded-lg transition flex justify-center items-center gap-2 whitespace-nowrap ${adminTab===t.id?'bg-white text-indigo-700 shadow-sm':'text-gray-500 hover:text-gray-700'}`}>
                    {t.i}{t.l}
                  </button>
                ))}
              </div>
              {adminTab==='data'&&<AdminDataMgmt staff={staffs} places={places} activities={activities}/>}
              {adminTab==='staff'&&<AdminStaffAnalysis logs={logs} staff={staffs}/>}
              {adminTab==='overall'&&<AdminOverall logs={logs}/>}
              {adminTab==='ranking'&&<AdminLeaderboard logs={logs}/>}
            </div>
          ) : (
            <div className="space-y-6">
              <div className="flex bg-white shadow-sm p-1.5 rounded-xl overflow-x-auto no-print gap-1">
                {[
                  {id:'log',l:'Log Harian',i:<FileText className="w-4 h-4"/>},
                  {id:'analysis',l:'Saringan',i:<BarChart2 className="w-4 h-4"/>},
                  {id:'graph',l:'Bimbingan',i:<TrendingUp className="w-4 h-4"/>},
                  {id:'list',l:'Senarai',i:<Calendar className="w-4 h-4"/>}
                ].map(t => (
                  <button key={t.id} onClick={()=>setStaffTab(t.id)} className={`flex-1 min-w-[120px] py-2.5 text-xs font-bold rounded-lg transition flex justify-center items-center gap-2 ${staffTab===t.id?'bg-indigo-600 text-white shadow-md':'text-gray-600 hover:bg-gray-50'}`}>
                    {t.i}{t.l}
                  </button>
                ))}
              </div>
              {staffTab==='log'&&<StaffLogForm userId={userId} userProfile={profile} places={places} activities={activities}/>}
              {staffTab==='analysis'&&<StaffIndividualAnalysis myLogs={logs.filter(l=>l.staffName===profile.fullName)}/>}
              {staffTab==='graph'&&<StaffGuidanceAnalysis myLogs={logs.filter(l=>l.staffName===profile.fullName)}/>}
              {staffTab==='list'&&<StaffListMonth logs={logs} profile={profile}/>}
            </div>
          )
        )}
      </main>
      
      <style>{`
        @media print { 
          .no-print { display: none !important; } 
          body { background: white; } 
          .shadow, .shadow-lg, .shadow-xl, .border { box-shadow: none !important; border: none !important; } 
          main { padding: 0 !important; max-width: 100% !important; }
        } 
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; } 
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; } 
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
      `}</style>
    </div>
  );
}