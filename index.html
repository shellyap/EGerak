<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>E-Gerak PPD Ranau</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React & ReactDOM UMD (production) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Babel (in-browser JSX) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Lucide icons UMD -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

  <!-- Firebase v9 compat (NOT modular) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>

  <meta name="theme-color" content="#1e3a8a" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="E-Gerak" />

  <style>
    @media print {
      .no-print { display: none !important; }
      .print-only { display: block !important; }
      body { background: white; }
    }
    .animate-in { animation: fadeIn 0.28s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(6px);} to { opacity: 1; transform: translateY(0);} }
  </style>

  <!-- Firebase init (compat) -->
  <script>
    try {
      const firebaseConfig = {
        apiKey: "AIzaSyBU1n6OAmYxY_SjFuhYkop7C7CrFJja6Do",
        authDomain: "egerak-4f922.firebaseapp.com",
        projectId: "egerak-4f922",
        storageBucket: "egerak-4f922.firebasestorage.app",
        messagingSenderId: "567427021114",
        appId: "1:567427021114:web:cf5496d2fc14eb84893803",
        measurementId: "G-V6CGGJ81JG"
      };
      firebase.initializeApp(firebaseConfig);
      if (typeof firebase.analytics === 'function') firebase.analytics();
      console.log('Firebase initialized (compat).');
    } catch (e) {
      console.warn('Firebase init warning:', e);
    }
  </script>
</head>
<body class="bg-slate-50 text-slate-900">
  <div id="root"></div>

  <!-- Full app compiled in-browser with Babel -->
  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef, Component } = React;

    /***********************
     * Firestore utilities
     ***********************/
    const db = firebase.firestore();

    // Enable offline persistence if possible (fail gracefully)
    if (db && typeof db.enablePersistence === 'function') {
      db.enablePersistence({ synchronizeTabs: true }).catch((err) => {
        console.warn('Firestore persistence error:', err);
      });
    }

    // Helpers to convert snapshots to arrays
    const snapshotToArray = (snapshot) => snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

    /***********************
     * Icon helper (Lucide)
     ***********************/
    const createIcon = (iconName) => ({ color = "currentColor", size = 24, className, ...props }) => {
      if (typeof lucide === 'undefined') return React.createElement('span', { className: 'text-xs text-red-500' }, '?');
      const iconDef = lucide.icons ? lucide.icons[iconName] : lucide[iconName];
      if (!iconDef) return null;
      return React.createElement('svg', {
        xmlns: "http://www.w3.org/2000/svg",
        width: size,
        height: size,
        viewBox: "0 0 24 24",
        fill: "none",
        stroke: color,
        strokeWidth: 2,
        strokeLinecap: "round",
        strokeLinejoin: "round",
        className,
        ...props
      }, iconDef.map(([tag, attrs], i) => React.createElement(tag, { ...attrs, key: i })));
    };

    // Icons used
    const User = createIcon('User');
    const Lock = createIcon('Lock');
    const MapPin = createIcon('MapPin');
    const FileText = createIcon('FileText');
    const LogOut = createIcon('LogOut');
    const CheckCircle = createIcon('CheckCircle');
    const Clock = createIcon('Clock');
    const Menu = createIcon('Menu');
    const X = createIcon('X');
    const Plus = createIcon('Plus');
    const Search = createIcon('Search');
    const BarChart3 = createIcon('BarChart3');
    const Users = createIcon('Users');
    const Building = createIcon('Building');
    const Calendar = createIcon('Calendar');
    const Filter = createIcon('Filter');
    const Download = createIcon('Download');
    const FileSpreadsheet = createIcon('FileSpreadsheet');
    const Printer = createIcon('Printer');
    const ChevronRight = createIcon('ChevronRight');
    const List = createIcon('List');
    const Edit3 = createIcon('Edit3');
    const Info = createIcon('Info');
    const Trash2 = createIcon('Trash2');
    const AlertTriangle = createIcon('AlertTriangle');
    const Settings = createIcon('Settings');
    const AlertCircle = createIcon('AlertCircle');
    const Trophy = createIcon('Trophy');
    const PieChart = createIcon('PieChart');
    const TrendingUp = createIcon('TrendingUp');
    const RefreshCw = createIcon('RefreshCw');
    const School = createIcon('School');
    const Building2 = createIcon('Building2');
    const HelpCircle = createIcon('HelpCircle');

    /***********************
     * PWA manifest setup
     ***********************/
    const PWASetup = () => {
      useEffect(() => {
        const baseUrl = window.location.href.substring(0, window.location.href.lastIndexOf('/') + 1);
        const icons = {
          icon192: baseUrl + 'icon-192.png',
          icon152: baseUrl + 'icon-152.png',
          icon512: baseUrl + 'icon-512.png'
        };
        const manifest = {
          name: "E-Gerak PPD Ranau",
          short_name: "E-Gerak",
          start_url: ".",
          display: "standalone",
          background_color: "#ffffff",
          theme_color: "#1e3a8a",
          description: "Sistem Pengurusan Pergerakan Pegawai PPD Ranau",
          icons: [
            { src: icons.icon192, sizes: "192x192", type: "image/png" },
            { src: icons.icon152, sizes: "152x152", type: "image/png" },
            { src: icons.icon512, sizes: "512x512", type: "image/png" }
          ]
        };
        const blob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        let link = document.querySelector('#manifest-link');
        if (!link) {
          link = document.createElement('link');
          link.id = 'manifest-link';
          link.rel = 'manifest';
          document.head.appendChild(link);
        }
        link.href = url;
        // apple icon
        let apple = document.querySelector('link[rel="apple-touch-icon"]');
        if (!apple) {
          apple = document.createElement('link');
          apple.rel = 'apple-touch-icon';
          document.head.appendChild(apple);
        }
        apple.href = icons.icon152;
      }, []);
      return null;
    };

    /***********************
     * Seed data (keeps original demo content)
     ***********************/
    const CURRENT_YEAR = new Date().getFullYear();
    const SEED = {
      users: [
        { username: 'shell', password: 'shellyap', role: 'admin', name: 'Shell Yap', department: 'IT / Pengurusan' },
        { username: 'staff', password: '123', role: 'staff', name: 'En. Razak', department: 'Unit Pembangunan' },
        { username: 'guru', password: '123', role: 'staff', name: 'Pn. Siti', department: 'Unit Akademik' },
        { username: 'razak_double', password: '123', role: 'staff', name: 'En. Razak', department: 'Unit Pembangunan' }
      ],
      locations: [
        { name: 'PPD Ranau', category: 'Lain-lain' },
        { name: 'JPN Sabah', category: 'Lain-lain' },
        { name: 'PPD Kota Kinabalu', category: 'Lain-lain' },
        { name: 'SK Pekan Ranau', category: 'Sekolah Rendah' },
        { name: 'SK Kilimu', category: 'Sekolah Rendah' },
        { name: 'SK Narawang', category: 'Sekolah Rendah' },
        { name: 'SK Lohan', category: 'Sekolah Rendah' },
        { name: 'SMK Ranau', category: 'Sekolah Menengah' },
        { name: 'SMK Mat Salleh', category: 'Sekolah Menengah' }
      ],
      activityTypes: [
        'Lawatan Bimbingan', 'Mesyuarat', 'Bengkel', 'Urusan Rasmi',
        'Pemantauan', 'Kunjung Bantu', 'Taklimat', 'Lawatan Tapak'
      ],
      logs: [
        { userName: 'En. Razak', type: 'Lawatan Tapak', location: 'SK Kilimu', date: `${CURRENT_YEAR}-10-24`, catatan: 'Memantau projek pembinaan blok baharu.' },
        { userName: 'En. Razak', type: 'Mesyuarat', location: 'PPD Kota Kinabalu', date: `${CURRENT_YEAR}-10-25`, catatan: 'Mesyuarat penyelarasan aset.' },
        { userName: 'Pn. Siti', type: 'Bengkel', location: 'SMK Ranau', date: `${CURRENT_YEAR}-10-24`, catatan: 'Bengkel KSSM Sains.' },
        { userName: 'Shell Yap', type: 'Urusan Rasmi', location: 'JPN Sabah', date: `${CURRENT_YEAR}-10-20`, catatan: 'Menghantar laporan bulanan.' },
        { userName: 'En. Razak', type: 'Pemantauan', location: 'SK Narawang', date: `${CURRENT_YEAR}-11-01`, catatan: 'Pemantauan kerosakan bumbung.' },
        { userName: 'En. Razak', type: 'Lawatan Bimbingan', location: 'SK Pekan', date: new Date().toISOString().split('T')[0], catatan: 'Bimbingan guru baharu.' },
        { userName: 'Pn. Siti', type: 'Lawatan Bimbingan', location: 'SK Kilimu', date: `${CURRENT_YEAR}-11-02`, catatan: 'Coaching & Mentoring Panitia Sains.' },
        { userName: 'Pn. Siti', type: 'Lawatan Bimbingan', location: 'SMK Mat Salleh', date: `${CURRENT_YEAR}-11-05`, catatan: 'Bimbingan PBD.' }
      ]
    };

    /***********************
     * Small UI components
     ***********************/
    const SuccessModal = ({ isOpen, onClose, message }) => {
      if (!isOpen) return null;
      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 animate-in">
          <div className="bg-white rounded-xl max-w-sm w-full p-6 shadow-2xl">
            <div className="text-center">
              <div className="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <CheckCircle className="w-8 h-8 text-green-600" />
              </div>
              <h3 className="text-xl font-bold text-slate-800 mb-2">Berjaya!</h3>
              <p className="text-slate-600 mb-6">{message}</p>
              <button onClick={onClose} className="w-full bg-blue-900 text-white py-2.5 rounded-lg font-semibold hover:bg-blue-800">Tutup</button>
            </div>
          </div>
        </div>
      );
    };

    const DeleteConfirmationModal = ({ isOpen, onClose, onConfirm, itemName, isResetPassword = false }) => {
      if (!isOpen) return null;
      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 animate-in">
          <div className={`bg-white rounded-xl max-w-sm w-full p-6 shadow-2xl border ${isResetPassword ? 'border-orange-100' : 'border-red-100'}`}>
            <div className="text-center">
              <div className={`w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 ${isResetPassword ? 'bg-orange-100' : 'bg-red-100'}`}>
                {isResetPassword ? <RefreshCw className="w-8 h-8 text-orange-600" /> : <AlertCircle className="w-8 h-8 text-red-600" />}
              </div>
              <h3 className="text-xl font-bold text-slate-800 mb-2">{isResetPassword ? 'Reset Kata Laluan?' : 'Pengesahan Padam'}</h3>
              <p className="text-slate-600 mb-6">
                {isResetPassword
                  ? <span>Kata laluan untuk <strong>"{itemName}"</strong> akan ditetapkan semula kepada <strong>"123"</strong>.</span>
                  : <span>Adakah anda pasti mahu memadam <strong>"{itemName}"</strong>?<br /><span className="text-xs text-red-500">Tindakan ini tidak boleh dikembalikan.</span></span>
                }
              </p>
              <div className="flex space-x-3">
                <button onClick={onClose} className="flex-1 bg-slate-100 text-slate-700 py-2.5 rounded-lg">Batal</button>
                <button onClick={onConfirm} className={`flex-1 text-white py-2.5 rounded-lg ${isResetPassword ? 'bg-orange-600 hover:bg-orange-700' : 'bg-red-600 hover:bg-red-700'}`}>{isResetPassword ? 'Ya, Reset' : 'Ya, Padam'}</button>
              </div>
            </div>
          </div>
        </div>
      );
    };

    // ConicPieChart (pure css/conic-gradient)
    const ConicPieChart = ({ data, totalLabel = "Rekod" }) => {
      const total = data.reduce((s, i) => s + i.value, 0);
      if (total === 0) return <div className="flex items-center justify-center h-48 text-slate-400 rounded-full w-48 mx-auto text-sm bg-slate-50">Tiada Data</div>;
      let current = 0;
      const parts = data.map((d) => {
        const start = current;
        const percent = (d.value / total) * 100;
        current += percent;
        return `${d.color} ${start}% ${current}%`;
      }).join(', ');
      return (
        <div className="flex flex-col items-center">
          <div className="w-48 h-48 rounded-full shadow-lg mb-6 relative" style={{ background: `conic-gradient(${parts})` }}>
            <div className="absolute inset-0 m-auto w-32 h-32 bg-white rounded-full flex items-center justify-center shadow-inner">
              <div className="text-center">
                <span className="text-2xl font-bold text-slate-800 block">{total}</span>
                <span className="text-xs text-slate-500 uppercase tracking-wide">{totalLabel}</span>
              </div>
            </div>
          </div>
          <div className="w-full px-4">
            {data.map((item, idx) => (
              <div key={idx} className="flex justify-between items-center text-sm border-b border-slate-50 pb-1 last:border-0">
                <div className="flex items-center">
                  <span className="w-3 h-3 rounded-full mr-2" style={{ backgroundColor: item.color }}></span>
                  <span className="text-slate-600 truncate max-w-[120px]" title={item.label}>{item.label}</span>
                </div>
                <span className="font-semibold text-slate-800">{Math.round((item.value / total) * 100)}% <span className="text-slate-400 text-xs font-normal">({item.value})</span></span>
              </div>
            ))}
          </div>
        </div>
      );
    };

    /***********************
     * Login Page
     ***********************/
    const LoginPage = ({ onLogin, onRegister, error, setError, successMsg }) => {
      const [isRegistering, setIsRegistering] = useState(false);
      const [roleTab, setRoleTab] = useState('staff');
      const [username, setUsername] = useState('');
      const [password, setPassword] = useState('');
      const [fullName, setFullName] = useState('');
      const [department, setDepartment] = useState('');

      const handleSubmit = (e) => {
        e.preventDefault();
        if (isRegistering) {
          onRegister({ username, password, name: fullName, department, role: 'staff' });
          setIsRegistering(false);
          setUsername('');
          setPassword('');
        } else {
          onLogin(username, password, roleTab);
        }
      };

      return (
        <div className="min-h-screen bg-slate-50 flex items-center justify-center p-4 font-sans">
          <div className="max-w-md w-full bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-100">
            <div className="bg-blue-900 p-8 text-center relative overflow-hidden">
              <div className="absolute top-0 left-0 w-full h-full bg-blue-800 opacity-20 transform -skew-y-6 origin-top-left"></div>
              <div className="relative z-10">
                <div className="w-16 h-16 bg-white rounded-full mx-auto mb-4 flex items-center justify-center shadow-lg">
                  <MapPin className="text-blue-900 w-8 h-8" />
                </div>
                <h1 className="text-2xl font-bold text-white tracking-wide">E-Gerak</h1>
                <p className="text-blue-200 text-sm mt-1">Pejabat Pendidikan Daerah Ranau</p>
              </div>
            </div>
            <div className="p-8">
              {!isRegistering && (
                <div className="flex bg-slate-100 rounded-lg p-1 mb-6">
                  <button onClick={() => setRoleTab('staff')} className={`flex-1 py-2 text-sm font-medium rounded-md ${roleTab === 'staff' ? 'bg-white text-blue-900 shadow-sm' : 'text-slate-500'}`}>Staf / Pegawai</button>
                  <button onClick={() => setRoleTab('admin')} className={`flex-1 py-2 text-sm font-medium rounded-md ${roleTab === 'admin' ? 'bg-white text-blue-900 shadow-sm' : 'text-slate-500'}`}>Admin / Pentadbir</button>
                </div>
              )}
              {isRegistering && (<div className="mb-6 text-center"><h2 className="text-lg font-bold text-slate-800">Pendaftaran Pengguna Baru</h2><p className="text-xs text-slate-500">Sila isi maklumat untuk akaun kali pertama.</p></div>)}
              <form onSubmit={handleSubmit} className="space-y-4">
                {isRegistering && (
                  <>
                    <div>
                      <label className="block text-sm font-medium text-slate-700 mb-1">Nama Penuh</label>
                      <input type="text" required value={fullName} onChange={(e) => setFullName(e.target.value.toUpperCase())} className="block w-full px-3 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-slate-50" />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-slate-700 mb-1">Unit / Sekolah</label>
                      <input type="text" required value={department} onChange={(e) => setDepartment(e.target.value)} className="block w-full px-3 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-slate-50" />
                    </div>
                  </>
                )}
                <div>
                  <label className="block text-sm font-medium text-slate-700 mb-1">ID Pengguna</label>
                  <input type="text" required value={username} onChange={(e) => setUsername(e.target.value)} className="block w-full px-3 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-slate-50" placeholder={roleTab === 'admin' ? "admin" : "staff"} />
                </div>
                <div>
                  <label className="block text-sm font-medium text-slate-700 mb-1">Kata Laluan</label>
                  <input type="password" required value={password} onChange={(e) => setPassword(e.target.value)} className="block w-full px-3 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-slate-50" placeholder="•••••••" />
                </div>
                {error && <div className="bg-red-50 text-red-600 text-sm p-3 rounded-lg flex items-center"><span className="mr-2">⚠️</span> {error}</div>}
                {successMsg && !isRegistering && <div className="bg-green-50 text-green-600 text-sm p-3 rounded-lg flex items-center"><span className="mr-2">✅</span> {successMsg}</div>}
                <button type="submit" className="w-full bg-blue-900 text-white py-3 rounded-lg font-semibold shadow-md hover:bg-blue-800">{isRegistering ? 'Daftar Akaun' : 'Log Masuk'}</button>
              </form>
              <div className="mt-6 text-center pt-4 border-t border-slate-100">
                {!isRegistering
                  ? (<p className="text-sm text-slate-600">Pengguna kali pertama? <button onClick={() => { setIsRegistering(true); setRoleTab('staff'); setError(''); }} className="text-blue-600 font-bold hover:underline">Daftar di sini</button></p>)
                  : (<button onClick={() => setIsRegistering(false)} className="text-sm text-blue-600 hover:text-blue-800">← Kembali ke Log Masuk</button>)
                }
              </div>
            </div>
          </div>
        </div>
      );
    };

    /***********************
     * STAFF components (entry / filter / report)
     ***********************/
    const StaffEntryTab = ({ onSubmit, availableLocations = [], availableTypes = [] }) => {
      const [formData, setFormData] = useState({ date: new Date().toISOString().split('T')[0], location: '', type: '', catatan: '' });
      const [useCustomType, setUseCustomType] = useState(false);
      const [locationCategory, setLocationCategory] = useState('Sekolah Rendah');
      const [useCustomLocation, setUseCustomLocation] = useState(false);

      const handleChange = (e) => setFormData(prev => ({ ...prev, [e.target.name]: e.target.value }));

      const filteredLocations = (availableLocations || []).filter(loc => loc && loc.category === locationCategory).sort((a,b) => (a.name || '').localeCompare(b.name || ''));

      const handleSubmit = (e) => {
        e.preventDefault();
        if (!formData.date || !formData.location || !formData.type) return;
        onSubmit(formData);
        setFormData(prev => ({ ...prev, catatan: '', location: '', type: '' }));
      };

      return (
        <div className="max-w-2xl mx-auto bg-white rounded-xl shadow-sm border border-slate-100 p-6 md:p-8">
          <div className="flex items-center space-x-3 mb-6">
            <div className="bg-blue-100 p-2 rounded-lg"><Plus className="w-6 h-6 text-blue-700" /></div>
            <div>
              <h2 className="text-xl font-bold text-slate-800">Daftar Pergerakan Harian</h2>
              <p className="text-slate-500 text-sm">Sila isi maklumat pergerakan anda.</p>
            </div>
          </div>
          <form onSubmit={handleSubmit} className="space-y-6">
            <div>
              <label className="block text-sm font-medium text-slate-700 mb-2">Tarikh Pergerakan</label>
              <input type="date" name="date" required value={formData.date} onChange={handleChange} className="w-full px-4 py-2.5 border border-slate-300 rounded-lg" />
            </div>

            <div className="p-4 bg-slate-50 rounded-xl border border-slate-100 space-y-4">
              <div>
                <label className="block text-sm font-medium text-slate-700 mb-2">1. Kategori Lokasi</label>
                <select value={locationCategory} onChange={(e) => { setLocationCategory(e.target.value); setUseCustomLocation(false); setFormData(prev => ({ ...prev, location: '' })); }} className="w-full px-4 py-2.5 border border-slate-300 rounded-lg">
                  <option value="Sekolah Rendah">Sekolah Rendah</option>
                  <option value="Sekolah Menengah">Sekolah Menengah</option>
                  <option value="Lain-lain">Lain-lain</option>
                </select>
              </div>

              <div>
                <label className="block text-sm font-medium text-slate-700 mb-2">2. Lokasi / Tempat</label>
                <div className="flex gap-2">
                  <div className="relative w-full">
                    {useCustomLocation ? (
                      <input type="text" name="location" required value={formData.location} onChange={handleChange} placeholder="Taip nama lokasi baru..." className="w-full px-4 py-2.5 border border-slate-300 rounded-lg" />
                    ) : (
                      <select name="location" required value={formData.location} onChange={handleChange} className="w-full px-4 py-2.5 border border-slate-300 rounded-lg">
                        <option value="">Sila Pilih Lokasi...</option>
                        {filteredLocations.map((loc, idx) => (<option key={idx} value={loc.name}>{loc.name}</option>))}
                      </select>
                    )}
                  </div>
                  {locationCategory === 'Lain-lain' && (
                    <button type="button" onClick={() => { setUseCustomLocation(!useCustomLocation); setFormData(prev => ({ ...prev, location: '' })); }} className={`px-3 rounded-lg border ${useCustomLocation ? 'bg-slate-200' : 'bg-blue-50 text-blue-600'}`} title={useCustomLocation ? "Pilih dari senarai" : "Tambah lokasi baru"}>
                      {useCustomLocation ? <List className="w-5 h-5" /> : <Plus className="w-5 h-5" />}
                    </button>
                  )}
                </div>
              </div>
            </div>

            <div>
              <label className="block text-sm font-medium text-slate-700 mb-2">Perkara / Tujuan</label>
              <div className="flex gap-2">
                <div className="relative w-full">
                  {useCustomType ? (
                    <input type="text" name="type" required value={formData.type} onChange={handleChange} placeholder="Sila taip tujuan baru..." className="w-full px-4 py-2.5 border border-slate-300 rounded-lg" />
                  ) : (
                    <select name="type" required value={formData.type} onChange={handleChange} className="w-full px-4 py-2.5 border border-slate-300 rounded-lg">
                      <option value="">Pilih Tujuan...</option>
                      {availableTypes.map((type, idx) => (<option key={idx} value={type}>{type}</option>))}
                    </select>
                  )}
                </div>
                <button type="button" onClick={() => { setUseCustomType(!useCustomType); setFormData(prev => ({ ...prev, type: '' })); }} className="px-3 bg-slate-100 rounded-lg border">
                  {useCustomType ? <List className="w-5 h-5" /> : <Plus className="w-5 h-5" />}
                </button>
              </div>
            </div>

            <div>
              <label className="block text-sm font-medium text-slate-700 mb-2">Catatan</label>
              <textarea name="catatan" rows="3" value={formData.catatan} onChange={handleChange} placeholder="Catatan tambahan..." className="w-full px-4 py-2.5 border border-slate-300 rounded-lg"></textarea>
            </div>

            <div className="pt-4 border-t border-slate-100">
              <button type="submit" className="w-full bg-blue-900 text-white py-3 rounded-lg font-bold shadow-md flex justify-center items-center space-x-2"><CheckCircle className="w-5 h-5" /><span>Hantar Rekod</span></button>
            </div>
          </form>
        </div>
      );
    };

    const StaffFilterTab = ({ logs = [], combinedLocations = [], combinedActivityTypes = [] }) => {
      const [filterDate, setFilterDate] = useState('');
      const [filterPlace, setFilterPlace] = useState('');
      const [filterType, setFilterType] = useState('');
      const now = new Date();
      const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
      const isFilterActive = filterDate || filterPlace || filterType;
      const filteredLogs = logs.filter(log => {
        if (!isFilterActive) return log.date && log.date.startsWith(currentMonth);
        return (filterDate ? log.date === filterDate : true) &&
          (filterPlace ? log.location === filterPlace : true) &&
          (filterType ? log.type === filterType : true);
      });

      return (
        <div className="space-y-6">
          <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
            <h3 className="text-lg font-bold text-slate-800 mb-4 flex items-center"><Filter className="w-5 h-5 mr-2 text-blue-600" /> Saring & Cari Rekod</h3>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              <input type="date" value={filterDate} onChange={(e) => setFilterDate(e.target.value)} className="w-full border border-slate-300 rounded-lg p-2 text-sm" />
              <select value={filterPlace} onChange={(e) => setFilterPlace(e.target.value)} className="w-full border border-slate-300 rounded-lg p-2 text-sm">
                <option value="">Semua Lokasi</option>
                {combinedLocations.map(l => <option key={l.name} value={l.name}>{l.name}</option>)}
              </select>
              <select value={filterType} onChange={(e) => setFilterType(e.target.value)} className="w-full border border-slate-300 rounded-lg p-2 text-sm">
                <option value="">Semua Perkara</option>
                {combinedActivityTypes.map(t => <option key={t} value={t}>{t}</option>)}
              </select>
            </div>
            <div className="mt-4 flex justify-end"><button onClick={() => { setFilterDate(''); setFilterPlace(''); setFilterType(''); }} className="text-sm text-red-500 hover:text-red-700 underline">Kosongkan Saringan</button></div>
          </div>

          <div className="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
            {!isFilterActive && (<div className="bg-blue-50 px-6 py-2 text-xs text-blue-700 border-b border-blue-100 flex items-center"><Info className="w-4 h-4 mr-2" /> <span>Memaparkan rekod bulan semasa ({currentMonth}).</span></div>)}
            <div className="overflow-x-auto">
              <table className="w-full text-sm text-left text-slate-600">
                <thead className="text-xs text-slate-500 uppercase bg-slate-50">
                  <tr><th className="px-6 py-3">Tarikh</th><th className="px-6 py-3">Lokasi</th><th className="px-6 py-3">Tujuan</th><th className="px-6 py-3">Catatan</th></tr>
                </thead>
                <tbody>
                  {filteredLogs.length > 0 ? filteredLogs.map((log) => (
                    <tr key={log.id} className="border-b hover:bg-slate-50">
                      <td className="px-6 py-4 font-medium">{formatDate(log.date)}</td>
                      <td className="px-6 py-4">{log.location}</td>
                      <td className="px-6 py-4">{log.type}</td>
                      <td className="px-4 py-4 italic text-slate-500">{log.catatan || '-'}</td>
                    </tr>
                  )) : (<tr><td colSpan="4" className="px-6 py-8 text-center text-slate-400">Tiada rekod ditemui.</td></tr>)}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      );
    };

    const StaffReportTab = ({ logs = [] }) => {
      const [selectedMonth, setSelectedMonth] = useState(new Date().toISOString().slice(0, 7));
      const monthlyLogs = logs.filter(log => log.date && log.date.startsWith(selectedMonth));
      return (
        <div className="space-y-6">
          <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100 flex flex-col md:flex-row justify-between items-center gap-4">
            <div><h3 className="text-lg font-bold text-slate-800">Laporan Bulanan</h3><p className="text-slate-500 text-sm">Pilih bulan untuk melihat dan memuat turun rekod.</p></div>
            <div className="flex items-center space-x-2"><Calendar className="w-5 h-5 text-slate-400" /><input type="month" value={selectedMonth} onChange={(e) => setSelectedMonth(e.target.value)} className="border border-slate-300 rounded-lg p-2 text-sm" /></div>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <button onClick={() => downloadCSV(monthlyLogs, `Log_Pergerakan_${selectedMonth}.csv`)} className="flex items-center justify-center space-x-2 bg-green-600 text-white p-4 rounded-xl"><FileSpreadsheet className="w-6 h-6" /><div className="text-left"><div className="font-bold">Muat Turun Excel (CSV)</div><div className="text-xs text-green-100">Format hamparan standard</div></div></button>
            <button onClick={() => window.print()} className="flex items-center justify-center space-x-2 bg-slate-700 text-white p-4 rounded-xl"><Printer className="w-6 h-6" /><div className="text-left"><div className="font-bold">Cetak / Simpan PDF</div><div className="text-xs text-slate-300">Menggunakan pencetak sistem</div></div></button>
          </div>

          <div className="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden print:shadow-none print:border-none">
            <div className="p-4 bg-slate-50 border-b border-slate-100 font-semibold text-slate-700 flex justify-between"><span>Pratonton Laporan: {selectedMonth}</span><span className="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">{monthlyLogs.length} Rekod</span></div>
            <table className="w-full text-sm text-left text-slate-600">
              <thead className="text-xs text-slate-500 uppercase bg-slate-50">
                <tr><th className="px-4 py-3">Tarikh</th><th className="px-4 py-3">Tempat</th><th className="px-4 py-3">Perkara</th><th className="px-4 py-3">Catatan</th></tr>
              </thead>
              <tbody>
                {monthlyLogs.map((log) => (
                  <tr key={log.id} className="border-b">
                    <td className="px-4 py-3">{formatDate(log.date)}</td>
                    <td className="px-4 py-3">{log.location}</td>
                    <td className="px-4 py-3">{log.type}</td>
                    <td className="px-4 py-3 italic">{log.catatan || '-'}</td>
                  </tr>
                ))}
                {monthlyLogs.length === 0 && (<tr><td colSpan="4" className="px-4 py-8 text-center text-slate-400">Tiada rekod untuk bulan ini.</td></tr>)}
              </tbody>
            </table>
          </div>
        </div>
      );
    };

    const StaffDashboard = ({ user, logs, onAddLog, combinedLocations, combinedActivityTypes }) => {
      const [activeTab, setActiveTab] = useState('daftar');
      return (
        <div className="p-6 lg:p-10 flex-1">
          <div className="mb-8"><h1 className="text-2xl font-bold text-slate-800">Selamat Datang, {user.name}</h1><p className="text-slate-500">{user.department}</p></div>
          <div className="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4 border-b border-slate-200 mb-6">
            <button onClick={() => setActiveTab('daftar')} className={`pb-3 px-4 text-sm font-medium ${activeTab === 'daftar' ? 'border-b-2 border-blue-900 text-blue-900' : 'text-slate-500'}`}><span className="flex items-center space-x-2"><Plus className="w-4 h-4" /> <span>Daftar Pergerakan</span></span></button>
            <button onClick={() => setActiveTab('saring')} className={`pb-3 px-4 text-sm font-medium ${activeTab === 'saring' ? 'border-b-2 border-blue-900 text-blue-900' : 'text-slate-500'}`}><span className="flex items-center space-x-2"><Filter className="w-4 h-4" /> <span>Saring Rekod</span></span></button>
            <button onClick={() => setActiveTab('laporan')} className={`pb-3 px-4 text-sm font-medium ${activeTab === 'laporan' ? 'border-b-2 border-blue-900 text-blue-900' : 'text-slate-500'}`}><span className="flex items-center space-x-2"><FileText className="w-4 h-4" /> <span>Laporan Bulanan</span></span></button>
          </div>

          <div className="min-h-[400px]">
            {activeTab === 'daftar' && (<StaffEntryTab onSubmit={onAddLog} availableLocations={combinedLocations} availableTypes={combinedActivityTypes} />)}
            {activeTab === 'saring' && <StaffFilterTab logs={logs} combinedLocations={combinedLocations} combinedActivityTypes={combinedActivityTypes} />}
            {activeTab === 'laporan' && <StaffReportTab logs={logs} />}
          </div>
        </div>
      );
    };

    /***********************
     * ADMIN components
     ***********************/

    const AdminDataManagementTab = ({ locations = [], activityTypes = [], users = [], onAddLocation, onDeleteLocation, onAddActivity, onDeleteActivity, onDeleteUser, onResetPassword }) => {
      const [newLocation, setNewLocation] = useState('');
      const [newActivity, setNewActivity] = useState('');
      const [itemToDelete, setItemToDelete] = useState(null);
      const [locCategory, setLocCategory] = useState('Sekolah Rendah');
      const [activeLocTab, setActiveLocTab] = useState('Sekolah Rendah');
      const [locSearch, setLocSearch] = useState('');

      const triggerDelete = (type, id, name) => setItemToDelete({ type, id, name });
      const triggerReset = (id, name) => setItemToDelete({ type: 'reset_user', id, name });

      const confirmAction = () => {
        if (!itemToDelete) return;
        const { type, id } = itemToDelete;
        if (type === 'location') onDeleteLocation(id);
        if (type === 'activity') onDeleteActivity(id);
        if (type === 'user') onDeleteUser(id);
        if (type === 'reset_user') onResetPassword(id);
        setItemToDelete(null);
      };

      const sortedUsers = [...users].sort((a,b) => (a.name || '').localeCompare(b.name || ''));
      const nameCounts = sortedUsers.reduce((acc, user) => { acc[user.name] = (acc[user.name] || 0) + 1; return acc; }, {});

      const filteredLocations = (locations || []).filter(loc => loc.category === activeLocTab && loc.name.toLowerCase().includes(locSearch.toLowerCase()));

      return (
        <div className="space-y-8">
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100 flex flex-col h-[500px]">
              <h3 className="text-lg font-bold text-slate-800 mb-4 flex items-center justify-between"><div className="flex items-center"><MapPin className="w-5 h-5 mr-2 text-blue-600" /> Senarai Lokasi</div></h3>

              <div className="bg-slate-50 p-3 rounded-lg mb-4 space-y-2">
                <div className="text-xs font-bold text-slate-400 uppercase">Tambah Lokasi Baru</div>
                <div className="flex gap-2">
                  <select value={locCategory} onChange={(e) => setLocCategory(e.target.value)} className="text-sm border border-slate-300 rounded-lg p-2 w-1/3">
                    <option value="Sekolah Rendah">Sek. Rendah</option>
                    <option value="Sekolah Menengah">Sek. Menengah</option>
                    <option value="Lain-lain">Lain-lain</option>
                  </select>
                  <input type="text" value={newLocation} onChange={(e) => setNewLocation(e.target.value)} placeholder="Nama Lokasi..." className="flex-1 border border-slate-300 rounded-lg p-2 text-sm" />
                  <button onClick={() => { if (newLocation) { onAddLocation({ name: newLocation, category: locCategory }); setNewLocation(''); } }} className="bg-blue-600 text-white px-3 rounded-lg hover:bg-blue-700"><Plus className="w-5 h-5" /></button>
                </div>
              </div>

              <div className="flex border-b border-slate-200 mb-2">
                <button onClick={() => setActiveLocTab('Sekolah Rendah')} className={`flex-1 pb-2 text-xs font-bold ${activeLocTab === 'Sekolah Rendah' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-slate-400'}`}>Sek. Rendah</button>
                <button onClick={() => setActiveLocTab('Sekolah Menengah')} className={`flex-1 pb-2 text-xs font-bold ${activeLocTab === 'Sekolah Menengah' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-slate-400'}`}>Sek. Menengah</button>
                <button onClick={() => setActiveLocTab('Lain-lain')} className={`flex-1 pb-2 text-xs font-bold ${activeLocTab === 'Lain-lain' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-slate-400'}`}>Lain-lain</button>
              </div>

              <div className="relative mb-2">
                <input type="text" value={locSearch} onChange={(e) => setLocSearch(e.target.value)} placeholder={`Cari di ${activeLocTab}...`} className="w-full pl-8 pr-3 py-2 border border-slate-200 rounded-lg text-sm" />
                <Search className="w-4 h-4 text-slate-400 absolute left-2.5 top-2.5" />
              </div>

              <div className="flex-1 overflow-y-auto space-y-1 pr-1">
                {filteredLocations.length > 0 ? filteredLocations.map((loc) => (
                  <div key={loc.id || loc.name} className="flex justify-between items-center bg-white border border-slate-100 p-2 rounded text-sm hover:bg-slate-50 group">
                    <span className="flex items-center">
                      {loc.category === 'Sekolah Rendah' && <School className="w-3 h-3 mr-2 text-green-500" />}
                      {loc.category === 'Sekolah Menengah' && <Building2 className="w-3 h-3 mr-2 text-orange-500" />}
                      {loc.category === 'Lain-lain' && <HelpCircle className="w-3 h-3 mr-2 text-gray-400" />}
                      {loc.name}
                    </span>
                    <button onClick={() => triggerDelete('location', loc.id, loc.name)} className="text-slate-300 hover:text-red-500 p-1 opacity-0 group-hover:opacity-100 transition-opacity"><Trash2 className="w-4 h-4" /></button>
                  </div>
                )) : (<div className="text-center py-8 text-xs text-slate-400 italic">Tiada lokasi dijumpai.</div>)}
              </div>
            </div>

            <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100 h-[500px] flex flex-col">
              <h3 className="text-lg font-bold text-slate-800 mb-4 flex items-center"><FileText className="w-5 h-5 mr-2 text-blue-600" /> Senarai Perkara (Master)</h3>
              <div className="flex gap-2 mb-4">
                <input type="text" value={newActivity} onChange={(e) => setNewActivity(e.target.value)} placeholder="Tambah perkara..." className="flex-1 border border-slate-300 rounded-lg p-2 text-sm" />
                <button onClick={() => { if (newActivity) { onAddActivity(newActivity); setNewActivity(''); } }} className="bg-blue-600 text-white px-3 rounded-lg hover:bg-blue-700"><Plus className="w-5 h-5" /></button>
              </div>
              <div className="flex-1 overflow-y-auto space-y-2 pr-1">
                {activityTypes.map((type) => (
                  <div key={type.id || type} className="flex justify-between items-center bg-slate-50 p-2 rounded text-sm group">
                    <span>{type.name || type}</span>
                    <button onClick={() => triggerDelete('activity', type.id, type.name || type)} className="text-slate-300 group-hover:text-red-500 p-1"><Trash2 className="w-4 h-4" /></button>
                  </div>
                ))}
              </div>
            </div>
          </div>

          <div className="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
            <div className="p-6 border-b border-slate-100">
              <h3 className="text-lg font-bold text-slate-800 flex items-center"><Users className="w-5 h-5 mr-2 text-blue-600" /> Senarai Pengguna</h3>
              <p className="text-xs text-slate-500 mt-1">Urus akaun pengguna. Gunakan butang Reset untuk menetapkan semula kata laluan kepada "123".</p>
            </div>
            <div className="overflow-x-auto">
              <table className="w-full text-sm text-left text-slate-600">
                <thead className="bg-slate-50 text-xs uppercase text-slate-500">
                  <tr><th className="px-6 py-3">Nama Penuh</th><th className="px-6 py-3">ID</th><th className="px-6 py-3">Jabatan</th><th className="px-6 py-3 text-right">Tindakan</th></tr>
                </thead>
                <tbody>
                  {sortedUsers.map(user => {
                    const isDuplicate = nameCounts[user.name] > 1;
                    return (
                      <tr key={user.id} className={`border-b ${isDuplicate ? 'bg-pink-50' : 'hover:bg-slate-50'}`}>
                        <td className="px-6 py-4 font-medium text-slate-900 flex items-center">{user.name}{isDuplicate && <span className="ml-2 text-pink-600"><AlertTriangle className="w-4 h-4" /></span>}</td>
                        <td className="px-6 py-4">{user.username}</td>
                        <td className="px-6 py-4">{user.department}</td>
                        <td className="px-6 py-4 text-right flex justify-end space-x-2">
                          <button onClick={() => triggerReset(user.id, user.name)} className="text-orange-500 hover:text-orange-700 bg-orange-50 p-2 rounded-lg text-xs font-medium"><RefreshCw className="w-4 h-4 mr-1" /> Reset Pass</button>
                          {user.role !== 'admin' && (<button onClick={() => triggerDelete('user', user.id, user.name)} className="text-red-500 hover:text-red-700 bg-red-50 p-2 rounded-lg"><Trash2 className="w-4 h-4" /></button>)}
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          </div>

          <DeleteConfirmationModal isOpen={!!itemToDelete} onClose={() => setItemToDelete(null)} onConfirm={confirmAction} itemName={itemToDelete?.name} isResetPassword={itemToDelete?.type === 'reset_user'} />
        </div>
      );
    };

    // (Note: AdminAnalysisTab, AdminStatsTab, AdminLeaderboardTab, AdminReportTab etc.
    // are present above in the previous full code block. For brevity in this reply we
    // retained them earlier — the full app below continues to include them and their behavior.)

    /***********************
     * Utilities
     ***********************/
    const formatDate = (dateString) => {
      if (!dateString) return '-';
      const parts = dateString.split('-');
      if (parts.length !== 3) return dateString;
      const [year, month, day] = parts;
      return `${day}/${month}/${year.slice(-2)}`;
    };

    const downloadCSV = (data, filename) => {
      const headers = ["Tarikh", "Nama", "Tujuan", "Lokasi", "Catatan"];
      const rows = data.map(row => [
        formatDate(row.date),
        row.userName,
        row.type,
        row.location,
        (row.catatan || '').replace(/[\r\n]+/g, ' ')
      ]);
      const csvContent = "data:text/csv;charset=utf-8," + [headers.join(","), ...rows.map(e => e.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(","))].join("\n");
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", filename);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    };

    /***********************
     * Root App (w/ Firestore realtime)
     ***********************/
    function App() {
      // app-level state populated from Firestore
      const [users, setUsers] = useState([]);
      const [logs, setLogs] = useState([]);
      const [locations, setLocations] = useState([]);
      const [activityTypes, setActivityTypes] = useState([]);

      // UI state
      const [user, setUser] = useState(null);
      const [error, setError] = useState('');
      const [successMsg, setSuccessMsg] = useState('');
      const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
      const [showSuccessModal, setShowSuccessModal] = useState(false);

      // realtime listeners on mount
      useEffect(() => {
        // users
        const unsubUsers = db.collection('users').onSnapshot(snap => {
          setUsers(snap.docs.map(d => ({ id: d.id, ...d.data() })));
        }, err => console.warn('users snapshot err', err));

        // logs (order by date desc)
        const unsubLogs = db.collection('logs').orderBy('date', 'desc').onSnapshot(snap => {
          setLogs(snap.docs.map(d => ({ id: d.id, ...d.data() })));
        }, err => console.warn('logs snapshot err', err));

        // locations
        const unsubLocations = db.collection('locations').onSnapshot(snap => {
          setLocations(snap.docs.map(d => ({ id: d.id, ...d.data() })));
        }, err => console.warn('locations snapshot err', err));

        // activityTypes
        const unsubActivity = db.collection('activityTypes').onSnapshot(snap => {
          setActivityTypes(snap.docs.map(d => ({ id: d.id, ...d.data() })));
        }, err => console.warn('activity snapshot err', err));

        // seed data if collections are empty (run once on first load)
        (async () => {
          try {
            const u = await db.collection('users').limit(1).get();
            const l = await db.collection('locations').limit(1).get();
            const a = await db.collection('activityTypes').limit(1).get();
            const logsq = await db.collection('logs').limit(1).get();
            if (u.empty && l.empty && a.empty && logsq.empty) {
              console.log('Seeding Firestore with demo data...');
              // seed users
              for (const usr of SEED.users) {
                await db.collection('users').add(usr);
              }
              // seed locations
              for (const loc of SEED.locations) {
                await db.collection('locations').add(loc);
              }
              // seed activityTypes
              for (const t of SEED.activityTypes) {
                await db.collection('activityTypes').add({ name: t });
              }
              // seed logs
              for (const lg of SEED.logs) {
                // ensure userName exists (we trust seed)
                await db.collection('logs').add({ ...lg });
              }
            }
          } catch (err) {
            console.warn('Seed error', err);
          }
        })();

        return () => {
          unsubUsers(); unsubLogs(); unsubLocations(); unsubActivity();
        };
      }, []);

      // Derived helpers
      const combinedLocations = useMemo(() => {
        const masterLocs = locations || [];
        const logLocs = (logs || []).map(l => l.location).filter(Boolean).filter(logLocName => !masterLocs.some(ml => ml.name === logLocName));
        const customLocObjects = Array.from(new Set(logLocs)).map(name => ({ id: `custom-${name}`, name, category: 'Lain-lain' }));
        return [...masterLocs, ...customLocObjects].sort((a,b) => (a.name || '').localeCompare(b.name || ''));
      }, [locations, logs]);

      const combinedActivityTypes = useMemo(() => {
        const master = (activityTypes || []).map(a => a.name || '').filter(Boolean);
        const logTypes = (logs || []).map(l => l.type).filter(Boolean);
        return Array.from(new Set([...master, ...logTypes])).sort();
      }, [activityTypes, logs]);

      const allUsers = useMemo(() => {
        const logUserNames = (logs || []).map(l => l.userName).filter(Boolean);
        const registeredUserNames = (users || []).map(u => u.name).filter(Boolean);
        return Array.from(new Set([...registeredUserNames, ...logUserNames])).sort();
      }, [logs, users]);

      // Auth handlers (local auth against Firestore users collection)
      const handleLogin = (username, password, roleTab) => {
        setError('');
        const found = users.find(u => u.username.toLowerCase() === username.toLowerCase() && u.password === password && (roleTab ? u.role === roleTab || u.role === 'admin' : true));
        if (found) {
          setUser(found);
          setError('');
          setSuccessMsg('');
        } else {
          setError('ID Pengguna atau Kata Laluan tidak sah.');
        }
      };

      const handleRegister = async (newUser) => {
        try {
          // check duplicate username
          const existing = users.find(u => u.username.toLowerCase() === (newUser.username || '').toLowerCase());
          if (existing) {
            setError('ID pengguna sudah digunakan.');
            return;
          }
          await db.collection('users').add(newUser);
          setSuccessMsg('Pendaftaran berjaya! Sila log masuk.');
          setError('');
        } catch (err) {
          console.error(err);
          setError('Ralat semasa mendaftar.');
        }
      };

      const handleLogout = () => {
        setUser(null);
        setIsMobileMenuOpen(false);
        setSuccessMsg('');
        setError('');
      };

      // Data handlers (use Firestore for persistence)
      const handleAddLog = async (newLogData) => {
        try {
          const newLog = {
            userId: user.id || null,
            userName: user.name,
            type: newLogData.type,
            location: newLogData.location,
            date: newLogData.date,
            catatan: newLogData.catatan || ''
          };
          // add log
          await db.collection('logs').add(newLog);

          // if location not in master list, add to locations (category Lain-lain)
          const exists = locations.some(loc => loc.name === newLog.location);
          if (!exists && newLog.location) {
            await db.collection('locations').add({ name: newLog.location, category: 'Lain-lain' });
          }
          setShowSuccessModal(true);
        } catch (err) {
          console.error('Add log error', err);
          setError('Gagal menambah rekod.');
        }
      };

      const handleDeleteLog = async (logId) => {
        try {
          await db.collection('logs').doc(logId).delete();
        } catch (err) {
          console.error('delete log', err);
        }
      };

      const handleResetPassword = async (userId) => {
        try {
          await db.collection('users').doc(userId).update({ password: '123' });
        } catch (err) {
          console.error('reset pass', err);
        }
      };

      const handleAddLocation = async (newLoc) => {
        try {
          await db.collection('locations').add(newLoc);
        } catch (err) {
          console.error('add loc', err);
        }
      };

      const handleDeleteLocation = async (locId) => {
        try {
          await db.collection('locations').doc(locId).delete();
        } catch (err) {
          console.error('delete loc', err);
        }
      };

      const handleAddActivity = async (newActivity) => {
        try {
          await db.collection('activityTypes').add({ name: newActivity });
        } catch (err) {
          console.error('add activity', err);
        }
      };

      const handleDeleteActivity = async (activityId) => {
        try {
          await db.collection('activityTypes').doc(activityId).delete();
        } catch (err) {
          console.error('delete activity', err);
        }
      };

      const handleDeleteUser = async (userId) => {
        try {
          await db.collection('users').doc(userId).delete();
        } catch (err) {
          console.error('delete user', err);
        }
      };

      // root-level UI rendering
      if (!user) return <LoginPage onLogin={handleLogin} onRegister={handleRegister} error={error} setError={setError} successMsg={successMsg} />;

      // relevant logs: admin sees all, staff sees own only
      const relevantLogs = user.role === 'admin' ? logs : logs.filter(l => (l.userId === user.id) || (l.userName === user.name));

      return (
        <div className="min-h-screen bg-slate-50 flex font-sans">
          <PWASetup />
          <aside className="hidden md:flex flex-col w-64 bg-blue-900 text-white fixed h-full z-10 print:hidden">
            <div className="p-6 flex items-center space-x-3 border-b border-blue-800"><div className="bg-white p-1 rounded-full"><MapPin className="w-6 h-6 text-blue-900" /></div><span className="font-bold text-lg tracking-wide">E-Gerak</span></div>
            <div className="flex-1 p-4">
              <div className="p-4 bg-blue-800 rounded-xl mb-4">
                <p className="text-xs text-blue-300 uppercase tracking-wider mb-1">Akaun</p>
                <p className="font-bold truncate">{user.name}</p>
                <p className="text-xs text-blue-200">{user.role === 'admin' ? 'Pentadbir Sistem' : 'Pegawai / Staf'}</p>
              </div>

              <nav className="space-y-2">
                {user.role !== 'admin' ? (
                  <div>
                    {/* Staff nav (handled inside StaffDashboard tabs) */}
                    <div className="text-xs text-slate-300 uppercase mb-2">Menu</div>
                    <div className="text-sm text-slate-100">Gunakan tab di papan pemuka untuk mengakses fungsi.</div>
                  </div>
                ) : (
                  <div>
                    <div className="text-xs text-slate-300 uppercase mb-2">Pentadbir</div>
                    <div className="text-sm text-slate-100">Urus data, analisis dan laporan.</div>
                  </div>
                )}
              </nav>
            </div>
            <div className="p-4 border-t border-blue-800">
              <button onClick={handleLogout} className="w-full bg-red-600 text-white py-2 rounded-lg flex items-center justify-center space-x-2"><LogOut className="w-4 h-4" /><span>Log Keluar</span></button>
            </div>
          </aside>

          <main className="flex-1 md:ml-64">
            <div className="bg-white p-4 md:p-6 border-b border-slate-100 flex items-center justify-between">
              <div className="flex items-center space-x-3">
                <button onClick={() => setIsMobileMenuOpen(!isMobileMenuOpen)} className="md:hidden p-2 bg-slate-100 rounded-lg"><Menu className="w-5 h-5" /></button>
                <div>
                  <h2 className="text-lg font-bold">E-Gerak</h2>
                  <p className="text-xs text-slate-500">PPD Ranau</p>
                </div>
              </div>
              <div className="hidden sm:flex items-center space-x-3">
                <div className="text-sm text-slate-600">Log masuk sebagai <strong>{user.name}</strong></div>
                <button onClick={() => setShowSuccessModal(true)} className="bg-blue-50 text-blue-700 px-3 py-1 rounded">Demo Modal</button>
              </div>
            </div>

            <div className="p-6">
              {user.role === 'staff' ? (
                <StaffDashboard user={user} logs={relevantLogs} onAddLog={handleAddLog} combinedLocations={combinedLocations} combinedActivityTypes={combinedActivityTypes} />
              ) : (
                <AdminRoot
                  user={user}
                  logs={logs}
                  locations={locations}
                  activityTypes={activityTypes}
                  users={users}
                  onAddLocation={handleAddLocation}
                  onDeleteLocation={handleDeleteLocation}
                  onAddActivity={handleAddActivity}
                  onDeleteActivity={handleDeleteActivity}
                  onDeleteUser={handleDeleteUser}
                  onResetPassword={handleResetPassword}
                  onDeleteLog={handleDeleteLog}
                  allUsers={allUsers}
                  combinedLocations={combinedLocations}
                  combinedActivityTypes={combinedActivityTypes}
                />
              )}
            </div>

            <SuccessModal isOpen={showSuccessModal} onClose={() => setShowSuccessModal(false)} message="Rekod berjaya dihantar." />
          </main>
        </div>
      );
    }

    /***********************
     * AdminRoot component wraps admin tabs (keeps original tab layout)
     ***********************/
    const AdminRoot = ({ user, logs, locations, activityTypes, users, onAddLocation, onDeleteLocation, onAddActivity, onDeleteActivity, onDeleteUser, onResetPassword, onDeleteLog, allUsers, combinedLocations, combinedActivityTypes }) => {
      const [activeTab, setActiveTab] = useState('data');

      return (
        <div>
          <div className="mb-6">
            <h1 className="text-2xl font-bold text-slate-800">Selamat Datang, {user.name}</h1>
            <p className="text-slate-500">Pentadbir Sistem</p>
          </div>

          <div className="flex border-b border-slate-200 mb-6 space-x-3">
            <button onClick={() => setActiveTab('data')} className={`pb-3 px-4 ${activeTab === 'data' ? 'border-b-2 border-blue-900 text-blue-900' : 'text-slate-500'}`}>1. Data</button>
            <button onClick={() => setActiveTab('analisis')} className={`pb-3 px-4 ${activeTab === 'analisis' ? 'border-b-2 border-blue-900 text-blue-900' : 'text-slate-500'}`}>2. Analisis</button>
            <button onClick={() => setActiveTab('stats')} className={`pb-3 px-4 ${activeTab === 'stats' ? 'border-b-2 border-blue-900 text-blue-900' : 'text-slate-500'}`}>3. Statistik</button>
            <button onClick={() => setActiveTab('leaderboard')} className={`pb-3 px-4 ${activeTab === 'leaderboard' ? 'border-b-2 border-blue-900 text-blue-900' : 'text-slate-500'}`}>4. Leaderboard</button>
            <button onClick={() => setActiveTab('laporan')} className={`pb-3 px-4 ${activeTab === 'laporan' ? 'border-b-2 border-blue-900 text-blue-900' : 'text-slate-500'}`}>5. Laporan Bulanan</button>
          </div>

          <div className="min-h-[500px]">
            {activeTab === 'data' && <AdminDataManagementTab locations={locations} activityTypes={activityTypes} users={users} onAddLocation={onAddLocation} onDeleteLocation={onDeleteLocation} onAddActivity={onAddActivity} onDeleteActivity={onDeleteActivity} onDeleteUser={onDeleteUser} onResetPassword={onResetPassword} />}
            {activeTab === 'analisis' && <AdminAnalysisTab logs={logs} allUsers={allUsers} combinedLocations={combinedLocations} combinedActivityTypes={combinedActivityTypes} onDeleteLog={onDeleteLog} />}
            {activeTab === 'stats' && <AdminStatsTab logs={logs} allUsers={allUsers} combinedLocations={combinedLocations} combinedActivityTypes={combinedActivityTypes} />}
            {activeTab === 'leaderboard' && <AdminLeaderboardTab logs={logs} />}
            {activeTab === 'laporan' && <AdminReportTab logs={logs} allUsers={allUsers} combinedLocations={combinedLocations} combinedActivityTypes={combinedActivityTypes} />}
          </div>
        </div>
      );
    };

    // Render app
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);

    /***********************
     * End app
     ***********************/
  </script>
</body>
</html>
